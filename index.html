<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lumina AI â€” Trading (Auto + Manual) + Assistant</title>
<meta name="description" content="Lumina AI â€” TradingView charts, 100+ forex pairs, 500+ indicators, auto/manual, Lumina assistant (camera, mic, upload)"/>
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
  :root{
    --bg: #071023;
    --panel: #071428;
    --card: rgba(255,255,255,0.02);
    --muted: #9fb0c8;
    --text: #e6f0fb;
    --accent: #ff7ae6;
    --accent-2: #b084ff;
    --green: #39d353;
    --red: #ff4d4f;
    --card-radius: 12px;
  }
  [data-theme="light"]{
    --bg:#ffffff; --panel:#f6f9ff; --card:rgba(2,6,23,0.02); --muted:#334155; --text:#071428; --accent:#ff4d4f;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:10px;border-radius:var(--card-radius);box-shadow:0 8px 30px rgba(2,6,23,0.4)}
  input,select,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  button.btn{cursor:pointer}
  #chart-wrap{height:56vh;border-radius:10px;overflow:hidden;margin-top:12px}
  #tv_chart_container{width:100%;height:100%}
  .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
  .left-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .signal-panel{margin-top:12px}
  .signal{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
  #luminaOpen{position:fixed;right:18px;bottom:18px;width:64px;height:64px;border-radius:18px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;border:none;z-index:1200;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,0.4)}
  #luminaSlide{position:fixed;right:0;top:0;height:100%;width:420px;max-width:95%;background:var(--panel);box-shadow:-20px 0 60px rgba(0,0,0,0.6);transform:translateX(100%);transition:transform .28s ease-in-out;z-index:1199;padding:12px;overflow:auto}
  #luminaSlide.open{transform:translateX(0)}
  .small{font-size:13px;color:var(--muted)}
  .pair-card{display:flex;gap:8px;align-items:center}
  .balance-box{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
  .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1400}
  .modal{background:var(--panel);padding:16px;border-radius:12px;min-width:260px;max-width:460px}
  .marker-buy{background:rgba(57,211,83,0.12);color:var(--green);padding:6px;border-radius:8px;font-weight:700}
  .marker-sell{background:rgba(255,77,79,0.09);color:var(--red);padding:6px;border-radius:8px;font-weight:700}
  .history{max-height:160px;overflow:auto;border-top:1px solid rgba(255,255,255,0.03);margin-top:8px;padding-top:8px}
  footer.note{color:var(--muted);font-size:13px;padding:12px;text-align:center}
  @media(max-width:900px){ #luminaSlide{width:100%;} #chart-wrap{height:44vh} .controls{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body data-theme="dark">
<div class="wrap">
  <div class="topbar">
    <div class="pair-card card">
      <div class="balance-box">
        <div><strong>Mode:</strong> <span id="modeLabel">DEMO</span></div>
        <div><strong>Balance:</strong> <span id="balanceVal">$50,000.00</span></div>
        <div class="small">Lot: <input id="topLot" value="0.01" style="width:80px"/></div>
      </div>

      <div style="margin-left:12px;display:flex;flex-direction:column;gap:6px">
        <input id="pairSearch" placeholder="Search pairs (EUR,USD,BTC...)" style="min-width:220px"/>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="pairSelect" style="min-width:170px"></select>
          <select id="timeframeSelect" title="Timeframe">
            <option value="1">1s</option><option value="60" selected>1m</option><option value="300">5m</option><option value="900">15m</option>
            <option value="3600">1h</option><option value="14400">4h</option><option value="86400">1d</option><option value="604800">1w</option><option value="2592000">1M</option><option value="31536000">1Y</option>
          </select>
        </div>
      </div>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <input id="bridgeUrl" placeholder="Bridge URL (https://...)" style="width:300px"/>
      <input id="bridgeUser" placeholder="user" style="width:86px"/>
      <input id="bridgePass" placeholder="pass" type="password" style="width:110px"/>
      <button id="connectBtn" class="btn">Connect Bridge</button>
      <button id="themeBtn" class="btn">Theme</button>
      <button id="accountToggle" class="btn">DEMO / REAL</button>
    </div>
  </div>

  <div id="chart-wrap" class="card">
    <div id="tv_chart_container"></div>
  </div>

  <div class="controls card">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="buyBtn" class="btn" style="background:rgba(57,211,83,0.08);color:var(--green)">BUY</button>
      <button id="sellBtn" class="btn" style="background:rgba(255,77,79,0.08);color:var(--red)">SELL</button>
      <input id="volume" placeholder="lot e.g. 0.01" style="width:110px"/>
      <input id="sl" placeholder="SL (price)" style="width:120px"/>
      <input id="tp" placeholder="TP (price)" style="width:120px"/>
      <button id="exitBtn" class="btn" style="margin-left:8px;background:#6b4b00;color:#fff">EXIT TRADE</button>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <label class="small">Mode</label>
      <select id="modeSelect"><option value="auto">AUTO</option><option value="manual" selected>MANUAL</option></select>
      <label class="small">ManualMin</label><input id="manualMin" type="number" value="95" style="width:72px"/>
      <label class="small">AutoMin</label><input id="autoMin" type="number" value="100" style="width:72px"/>
      <select id="indicatorSelect"><option>Loading indicators...</option></select>
    </div>
  </div>

  <div class="card signal-panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Live Signal Panel</strong>
      <div class="small">Signals for selected pair & timeframe</div>
    </div>
    <div id="signalList" style="max-height:220px;overflow:auto;margin-top:8px"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="exportBtn" class="btn">Export</button>
      <button id="clearBtn" class="btn">Clear</button>
    </div>

    <div style="margin-top:12px">
      <strong>History</strong>
      <div id="history" class="history small"></div>
    </div>
  </div>

  <footer class="note">Lumina POC â€” demo balance shows $50,000. For production: deploy secure Bridge server & MT5 EA and keep secrets server-side only.</footer>
</div>

<!-- Lumina assistant open button -->
<button id="luminaOpen" title="Open Lumina">Lâ™¡</button>

<!-- Assistant slide -->
<div id="luminaSlide" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>Lumina â€” Assistant</h3>
    <button id="luminaClose" class="btn">Close</button>
  </div>

  <div style="margin-top:8px">
    <div style="display:flex;gap:8px">
      <input id="luminaInput" placeholder="Ask Lumina..." style="flex:1;padding:10px;border-radius:8px"/>
      <button id="luminaSend" class="btn">ðŸ’¬</button>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
      <button id="luminaSpeakBtn" class="btn">ðŸŽ¤</button>
      <label class="small">Voice Mode</label>
      <select id="voiceMode">
        <option value="auto">Auto (sweet/professional)</option>
        <option value="sweet">Sweet girlfriend</option>
        <option value="pro">Professional</option>
      </select>
      <label style="margin-left:auto"><input id="speakOnText" type="checkbox"/> Assistant speaks on text</label>
    </div>

    <div id="luminaChat" style="margin-top:12px;max-height:420px;overflow:auto;border-top:1px solid rgba(255,255,255,0.03);padding-top:8px"></div>
    <div style="margin-top:8px">
      <input id="fileUpload" type="file" accept="image/*,video/*,.pdf" />
      <button id="cameraBtn" class="btn">Camera</button>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal card" id="confirmModal">
    <h3>Confirm Trade</h3>
    <div id="confirmDetails" class="small"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="confirmCancel" class="btn">Cancel</button>
      <button id="confirmOk" class="btn" style="background:var(--accent);color:#fff">Confirm</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   PAIRS + TIMEZONES + INDICATORS
   --------------------------- */
const timezoneMap = {
  "America/New_York":"New York","Europe/London":"London","Asia/Tokyo":"Tokyo","Asia/Kolkata":"India",
  "Australia/Sydney":"Sydney","America/Chicago":"Chicago","America/Los_Angeles":"Los Angeles",
  "America/Sao_Paulo":"Sao Paulo","Asia/Dubai":"Dubai","Asia/Singapore":"Singapore","Asia/Shanghai":"Shanghai",
  "Asia/Ho_Chi_Minh":"Ho Chi Minh","Europe/Berlin":"Berlin","Europe/Moscow":"Moscow","Etc/UTC":"UTC","exchange":"Exchange"
};

const commonPairs = [
  "EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD","EURGBP","EURJPY","GBPJPY",
  "AUDJPY","AUDCAD","AUDCHF","CADJPY","CHFJPY","EURAUD","EURNZD","GBPAUD","GBPCAD","GBPCHF",
  "USDSGD","USDHKD","USDMXN","USDZAR","USDNOK","USDSEK","USDTRY","USDBRL","EURCAD","EURCHF",
  "XAUUSD","XAGUSD","BTCUSD","ETHUSD","LTCUSD"
];
let pairs = Array.from(new Set(commonPairs));
const extras = ['CAD','CHF','AUD','NZD','JPY','GBP','EUR','USD','MXN','ZAR','SEK','NOK','TRY','BRL','INR','CNY','SGD','HKD','KRW','PLN','RUB'];
for(let a=0;a<extras.length;a++){ for(let b=0;b<extras.length;b++){ if(a===b) continue; pairs.push(extras[a]+extras[b]); } }
pairs = Array.from(new Set(pairs)).slice(0,160);
const pairSelect = document.getElementById('pairSelect');
pairs.forEach(p=>{
  let tz = "Etc/UTC";
  if(p.includes("USD")) tz = "America/New_York";
  if(p.includes("EUR")) tz = "Europe/London";
  if(p.includes("JPY")) tz = "Asia/Tokyo";
  if(p.includes("AUD")||p.includes("NZD")) tz = "Australia/Sydney";
  if(p.includes("SGD")||p.includes("HKD")||p.includes("CNY")) tz = "Asia/Singapore";
  const opt = document.createElement('option'); opt.value=p; opt.textContent = p.slice(0,3)+'/'+p.slice(3); opt.dataset.tz = tz;
  pairSelect.appendChild(opt);
});
document.getElementById('pairSearch').addEventListener('input', e=>{
  const q = e.target.value.trim().toUpperCase();
  pairSelect.innerHTML = '';
  pairs.filter(p=>p.includes(q)).forEach(p=>{
    const tz = p.includes("USD") ? "America/New_York" : (p.includes("JPY") ? "Asia/Tokyo" : "Europe/London");
    const o=document.createElement('option'); o.value=p; o.textContent = p.slice(0,3)+'/'+p.slice(3); o.dataset.tz = tz; pairSelect.appendChild(o);
  });
});

/* indicators fill */
const indicatorSelect = document.getElementById('indicatorSelect');
const commonIndicators = ["RSI","MACD","Stochastic","Bollinger Bands","EMA","SMA","VWAP","ATR","ADX","CCI","OBV","Ichimoku","Parabolic SAR","Volume Profile","Momentum","ROC","Williams %R","SuperTrend","Donchian Channels","Hull MA","Fisher Transform"];
commonIndicators.forEach(i=>{ const o=document.createElement('option'); o.value=i; o.textContent=i; indicatorSelect.appendChild(o); });
for(let k=1;k<=520;k++){ const name='Custom Indicator '+k; const o=document.createElement('option'); o.value=name; o.textContent=name; indicatorSelect.appendChild(o); }

/* ---------------------------
   TradingView widget init
   --------------------------- */
let tvWidget = null;
function mapIntervalToTV(sec){
  const map = { '1':"1",'60':"1",'300':"5",'900':"15",'3600':"60",'14400':"240",'86400':"D",'604800':"W",'2592000':"M",'31536000':"W" };
  return map[sec] || (sec/60).toString();
}
function createTV(symbol='EURUSD', intervalSec='60', timezone='Etc/UTC'){
  try{ document.getElementById('tv_chart_container').innerHTML=''; }catch(e){}
  const tvSymbol = symbol.length===6 ? 'FX:'+symbol : symbol;
  const widgetOptions = {
    symbol: tvSymbol,
    interval: mapIntervalToTV(intervalSec),
    container_id: "tv_chart_container",
    library_path: "https://s3.tradingview.com/",
    locale: "en",
    disabled_features: ["use_localstorage_for_settings"],
    enabled_features: ["study_templates"],
    overrides: {
      "mainSeriesProperties.candleStyle.upColor": "#39d353",
      "mainSeriesProperties.candleStyle.downColor": "#ff4d4f",
      "paneProperties.background": "transparent"
    },
    theme: document.body.getAttribute('data-theme') === 'dark' ? "Dark" : "Light",
    autosize: true,
    timezone: timezone
  };
  try{ tvWidget = new TradingView.widget(widgetOptions); }catch(e){ console.warn('TradingView init fail',e); document.getElementById('tv_chart_container').innerHTML = '<div class="small">TradingView unavailable here.</div>'; }
}

/* ---------------------------
   SIGNAL ENGINE (POC)
   - Manual signals show only (>=ManualMin)
   - Auto will attempt to send to Bridge (if configured) when >= AutoMin
   - Demo balance and history updated
   --------------------------- */
let signals = [], history = [];
const signalList = document.getElementById('signalList');
const historyDiv = document.getElementById('history');
function renderSignals(){ signalList.innerHTML=''; signals.slice(0,80).forEach(s=>{
  const el = document.createElement('div'); el.className='signal';
  el.innerHTML = `<div><strong>${s.type.toUpperCase()}</strong><div class="small">${s.pair} â€¢ ${s.tfLabel}</div></div><div style="text-align:right"><div>${s.price}</div><div class="small">${s.confidence}%</div></div>`;
  signalList.appendChild(el);
});}
function renderHistory(){ historyDiv.innerHTML=''; history.slice(0,80).forEach(h=>{ const d=document.createElement('div'); d.className='small'; d.textContent = `${h.timeLabel} â€¢ ${h.pair} â€¢ ${h.side.toUpperCase()} â€¢ ${h.volume} â€¢ ${h.result || ''}`; historyDiv.appendChild(d); }); }

/* Demo state */
let demoBalance = 50000.0;
let demoOpenTrades = [];

/* Add a trade to history & adjust mock balance (demo) */
function applyDemoTrade(body, manual=false, isExit=false){
  // body: {ea_id,cmd,symbol,volume,sl,tp,time,confidence}
  const pair = body.symbol;
  const vol = parseFloat(body.volume) || parseFloat(document.getElementById('topLot').value) || 0.01;
  const price = body.price || (1.0 + Math.random()*0.01);
  const result = isExit ? 'closed' : 'opened';
  const now = new Date();
  history.unshift({ timeLabel: now.toLocaleString(), pair, side: body.cmd, volume: vol, result });
  // simple demo: if open subtract used margin approx; if close add a simulated P/L
  if(!isExit){
    // reserve small margin
    demoBalance -= vol * 10; // mock margin hold
    demoOpenTrades.push({id:Date.now(), pair, side:body.cmd, vol, entry:price});
  } else {
    // close last matching trade for pair
    const idx = demoOpenTrades.findIndex(t=>t.pair===pair && t.side===body.cmd);
    if(idx>=0){
      const t = demoOpenTrades.splice(idx,1)[0];
      // mock profit/loss random
      const pl = ((Math.random()-0.45) * vol * 50); // random pnl
      demoBalance += (vol*10) + pl;
      history[0].result += ` â€¢ P/L ${pl.toFixed(2)}`;
    }
  }
  document.getElementById('balanceVal').textContent = `$${demoBalance.toFixed(2)}`;
  renderHistory();
}

/* mark buy/sell on chart (TradingView markers) - tvWidget API differs across versions; we use series markers if available */
let markerIdCounter=0;
function addChartMarker(type, time, text){
  try{
    // TradingView's widget exposes chart().createMultipointShape etc. but public embed is limited.
    // We'll append a small floating custom element above chart container for demo markers.
    const mark = document.createElement('div');
    mark.style.position='absolute';
    mark.style.zIndex=50;
    mark.style.right='24px';
    mark.style.top=(40 + (markerIdCounter*34))+'px';
    mark.style.padding='6px 8px';
    mark.style.borderRadius='8px';
    mark.style.fontWeight='700';
    mark.textContent = text;
    if(type==='buy'){ mark.style.background='rgba(57,211,83,0.12)'; mark.style.color=getComputedStyle(document.documentElement).getPropertyValue('--green') || '#39d353'; }
    else { mark.style.background='rgba(255,77,79,0.09)'; mark.style.color=getComputedStyle(document.documentElement).getPropertyValue('--red') || '#ff4d4f'; }
    mark.className='chartMarker';
    document.getElementById('tv_chart_container').appendChild(mark);
    markerIdCounter++;
    if(markerIdCounter>8){
      // cleanup older
      const old = document.querySelectorAll('.chartMarker');
      if(old[0]) old[0].remove();
    }
  }catch(e){console.warn('marker fail',e);}
}

/* naive analyzer: produce manual-level signals occasionally */
function analyzeAndEmit(){
  const pair = pairSelect.value || 'EURUSD';
  const tf = document.getElementById('timeframeSelect').value;
  const tfLabel = (tf==='60'?'1m':tf);
  // compute a random score simulating deep analysis (POC)
  const score = Math.random()*100;
  // manual confidence: 95..100 needed
  const manualMin = parseInt(document.getElementById('manualMin').value || 95);
  const autoMin = parseInt(document.getElementById('autoMin').value || 100);
  const confManual = Math.round(90 + (score/100)*10); // 90..100
  const confAuto = Math.round(10 + score); // 10..110
  // emulate a closed candle
  const closed = { time: Date.now(), open:1, high:1, low:1, close:(1.0 + Math.random()*0.01).toFixed(5) };

  // Manual signal
  if(confManual >= manualMin){
    const type = (Math.random()>0.5?'buy':'sell');
    const sig = { pair, tf, tfLabel, type, price:closed.close, confidence: confManual, time: closed.time };
    signals.unshift(sig);
    if(signals.length>200) signals.pop();
    renderSignals();
    addChartMarker(type, closed.time, `${type.toUpperCase()} ${confManual}%`);
  }

  // Auto execution possibility
  if(confAuto >= autoMin){
    const cmd = (Math.random()>0.5?'buy':'sell');
    const body = { ea_id:'lumina_ea_01', cmd, symbol:pair, volume: parseFloat(document.getElementById('volume').value)||parseFloat(document.getElementById('topLot').value)||0.01, sl: parseFloat(document.getElementById('sl').value)||0, tp: parseFloat(document.getElementById('tp').value)||0, time: Date.now(), confidence:confAuto, price:closed.close };
    // if bridge configured send to backend - otherwise demo apply
    if(window.BRIDGE_URL && window.BRIDGE_USER){
      fetch(window.BRIDGE_URL + '/api/trade', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Basic '+btoa(window.BRIDGE_USER+':'+window.BRIDGE_PASS)}, body: JSON.stringify(body) })
      .then(r=>r.json()).then(j=>{ console.log('bridge queued',j); addChartMarker(cmd, Date.now(), `${cmd.toUpperCase()} ${confAuto}%`); applyDemoTrade(body,false);})
      .catch(e=>{ console.warn('bridge send fail',e); applyDemoTrade(body,false); });
    } else {
      // demo execution
      addChartMarker(cmd, Date.now(), `${cmd.toUpperCase()} ${confAuto}%`);
      applyDemoTrade(body,false);
    }
  }
}

/* start periodic simulated analysis */
setInterval(analyzeAndEmit, 7000);

/* ---------------------------
   UI actions: buy/sell manual confirm & send
   --------------------------- */
const modalBackdrop = document.getElementById('modalBackdrop');
let pendingTrade = null;
function openConfirm(body){
  pendingTrade = body;
  document.getElementById('confirmDetails').innerHTML = `
    <div class="small">Pair: <strong>${body.symbol}</strong></div>
    <div class="small">Side: <strong>${body.cmd}</strong></div>
    <div class="small">Volume: <strong>${body.volume}</strong></div>
    <div class="small">SL: ${body.sl || 'â€”'} TP: ${body.tp || 'â€”'}</div>
    <div class="small">Confidence: ${body.confidence || 'â€”'}</div>
  `;
  modalBackdrop.style.display = 'flex';
}
document.getElementById('confirmCancel').addEventListener('click', ()=>{ modalBackdrop.style.display='none'; pendingTrade=null; });
document.getElementById('confirmOk').addEventListener('click', async ()=>{
  if(!pendingTrade) return;
  // on confirm -> send to bridge or apply demo
  if(window.BRIDGE_URL && window.BRIDGE_USER){
    try{
      const res = await fetch(window.BRIDGE_URL + '/api/trade', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Basic '+btoa(window.BRIDGE_USER+':'+window.BRIDGE_PASS)}, body: JSON.stringify(pendingTrade) });
      const j = await res.json();
      alert(j.ok ? 'Trade queued' : 'Bridge response: '+JSON.stringify(j));
      applyDemoTrade(pendingTrade,false);
    }catch(e){ alert('Failed to send to bridge â€” demo applied'); applyDemoTrade(pendingTrade,false); }
  } else {
    applyDemoTrade(pendingTrade,false);
    alert('Demo trade applied');
  }
  modalBackdrop.style.display='none'; pendingTrade=null;
});

/* Manual button handlers open confirm */
document.getElementById('buyBtn').addEventListener('click', ()=>{ const b = buildTrade('buy'); if(document.getElementById('modeSelect').value === 'manual'){ openConfirm(b); } else sendImmediate(b); });
document.getElementById('sellBtn').addEventListener('click', ()=>{ const b = buildTrade('sell'); if(document.getElementById('modeSelect').value === 'manual'){ openConfirm(b); } else sendImmediate(b); });
function buildTrade(side){
  const volume = parseFloat(document.getElementById('volume').value) || parseFloat(document.getElementById('topLot').value) || 0.01;
  return { ea_id:'lumina_ea_01', cmd:side, symbol: pairSelect.value, volume, sl: parseFloat(document.getElementById('sl').value)||0, tp: parseFloat(document.getElementById('tp').value)||0, time: Date.now(), confidence: 99, price: null };
}
async function sendImmediate(body){
  // Auto mode immediate send (if bridge set) else demo
  if(window.BRIDGE_URL && window.BRIDGE_USER){
    try{
      const r = await fetch(window.BRIDGE_URL + '/api/trade', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Basic '+btoa(window.BRIDGE_USER+':'+window.BRIDGE_PASS)}, body: JSON.stringify(body) });
      const j = await r.json(); alert(j.ok ? 'Auto trade queued' : 'Bridge response: '+JSON.stringify(j)); applyDemoTrade(body,false);
    }catch(e){ alert('Bridge fail â€” demo applied'); applyDemoTrade(body,false); }
  } else {
    applyDemoTrade(body,false); alert('Demo trade applied');
  }
}

/* Exit trade button - closes last open trade same side for demo */
document.getElementById('exitBtn').addEventListener('click', ()=>{
  const side = (Math.random()>0.5?'buy':'sell'); // for demo pick random or could ask user which trade to exit
  const body = { ea_id:'lumina_ea_01', cmd: side, symbol: pairSelect.value, volume: parseFloat(document.getElementById('volume').value)||0.01, time: Date.now() };
  // demo close
  applyDemoTrade(body,true);
  alert('Demo exit executed');
});

/* ---------------------------
   Bridge and UI connect
   --------------------------- */
document.getElementById('connectBtn').addEventListener('click', ()=>{
  window.BRIDGE_URL = document.getElementById('bridgeUrl').value.trim();
  window.BRIDGE_USER = document.getElementById('bridgeUser').value.trim();
  window.BRIDGE_PASS = document.getElementById('bridgePass').value.trim();
  alert('Bridge set locally for frontend demo (production: set server-side secrets).');
});

/* Export / Clear signals */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = JSON.stringify(signals.concat(history), null, 2);
  const blob = new Blob([data],{type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='lumina_data.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('clearBtn').addEventListener('click', ()=>{ signals = []; history = []; renderSignals(); renderHistory(); });

/* ---------------------------
   Theme toggle + account toggle + pair change + initial TV
   --------------------------- */
document.getElementById('themeBtn').addEventListener('click', ()=>{
  const cur = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', cur);
  // re-create chart to switch tv theme
  createTV(pairSelect.value || 'EURUSD', document.getElementById('timeframeSelect').value, pairSelect.selectedOptions[0] ? pairSelect.selectedOptions[0].dataset.tz : 'Etc/UTC');
});
document.getElementById('accountToggle').addEventListener('click', ()=>{
  const isDemo = document.getElementById('modeLabel').textContent === 'DEMO';
  if(isDemo){ document.getElementById('modeLabel').textContent = 'REAL'; alert('Switched to REAL (test only front-end)'); } else { document.getElementById('modeLabel').textContent = 'DEMO'; }
});
pairSelect.addEventListener('change', ()=>{ createTV(pairSelect.value, document.getElementById('timeframeSelect').value, pairSelect.selectedOptions[0].dataset.tz); });

/* ---------------------------
   Lumina assistant: chat, mic, TTS (auto voice)
   --------------------------- */
const luminaOpen = document.getElementById('luminaOpen'), luminaSlide = document.getElementById('luminaSlide');
luminaOpen.addEventListener('click', ()=>luminaSlide.classList.toggle('open'));
document.getElementById('luminaClose').addEventListener('click', ()=>luminaSlide.classList.remove('open'));

function appendChat(who, msg){
  const d = document.createElement('div'); d.innerHTML = `<strong>${who}:</strong> <div class="small">${msg}</div>`; document.getElementById('luminaChat').appendChild(d); document.getElementById('luminaChat').scrollTop = document.getElementById('luminaChat').scrollHeight;
}
function chooseVoiceStyle(text){
  // simple heuristic: affectionate words => sweet; trading terms => professional
  const sweetWords = ['hi','hey','love','baby','babe','sweet','xoxo','hello','how are you'];
  const lower=text.toLowerCase();
  for(const w of sweetWords) if(lower.includes(w)) return 'sweet';
  return 'pro';
}
function speakText(text, styleOverride=null){
  try{
    const utter = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    let chosen=null;
    const mode = document.getElementById('voiceMode').value;
    let style = mode === 'auto' ? chooseVoiceStyle(text) : mode;
    if(styleOverride) style = styleOverride;
    // select voice heuristic: pick an english female for sweet, neutral for pro
    if(style==='sweet'){
      chosen = voices.find(v=>/female|zira|samantha|amelia|eva|alloy/i.test(v.name) || v.lang.startsWith('en'));
      utter.pitch = 1.15; utter.rate = 1.0;
    } else {
      chosen = voices.find(v=>v.lang.startsWith('en'));
      utter.pitch = 1.0; utter.rate = 1.0;
    }
    if(chosen) utter.voice = chosen;
    speechSynthesis.speak(utter);
  }catch(e){ console.warn('TTS fail', e); }
}
document.getElementById('luminaSend').addEventListener('click', ()=>{ const q = document.getElementById('luminaInput').value.trim(); if(!q) return; appendChat('You', q); document.getElementById('luminaInput').value=''; // craft POC answer
  setTimeout(()=>{ const style = chooseVoiceStyle(q); const reply = style==='sweet' ? `Hi baby ðŸ’• â€” I checked ${pairSelect.value} â€” want me to analyze now?` : `Lumina: I reviewed ${pairSelect.value}. POC suggests checking trend, volume, and order blocks.`; appendChat('Lumina', reply); if(document.getElementById('speakOnText').checked) speakText(reply); },600);
});

/* speech recognition */
let recognition = null;
document.getElementById('luminaSpeakBtn').addEventListener('click', async ()=>{
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){ alert('SpeechRecognition not supported'); return; }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR(); recognition.lang='en-US'; recognition.interimResults=false; recognition.maxAlternatives=1;
  recognition.start();
  recognition.onresult = (ev)=>{ const text = ev.results[0][0].transcript; document.getElementById('luminaInput').value = text; document.getElementById('luminaSend').click(); };
  recognition.onerror = ()=>{ alert('Speech error'); };
});

/* camera upload (simple) */
document.getElementById('cameraBtn').addEventListener('click', async ()=>{
  try{ const s = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); const v = document.createElement('video'); v.autoplay=true; v.playsInline=true; v.srcObject = s; v.style.width='100%'; document.getElementById('luminaChat').appendChild(v); }catch(e){ alert('Camera unavailable'); }
});

/* ---------------------------
   Initialize TV + default state
   --------------------------- */
pairSelect.value = 'EURUSD';
createTV(pairSelect.value, document.getElementById('timeframeSelect').value, pairSelect.selectedOptions[0].dataset.tz || 'Etc/UTC');
document.getElementById('balanceVal').textContent = `$${demoBalance.toFixed(2)}`;

/* quick load small history sample */
history.push({ timeLabel: new Date().toLocaleString(), pair:'EURUSD', side:'buy', volume:0.01, result:'opened' });
renderHistory();
renderSignals();

console.log('Lumina AI frontend (final POC) loaded. For production: deploy a secure Bridge server and an MT5 EA and keep secrets server-side only.');
</script>
</body>
</html>
