<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lumina AI â€” Max Power (Fixed)</title>
<meta name="description" content="Lumina AI POC â€” updated: analyze-first auto-exec, assistant full chat, demo balance updates, safer auto rules" />
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
  :root{
    --bg:#071023; --panel:#071428; --muted:#9fb0c8; --accent:#39d353; --danger:#ff4d4f;
    --card:#0b1a2a; --glass: rgba(255,255,255,0.02);
  }
  [data-theme="light"]{
    --bg:#f8fafc; --panel:#ffffff; --muted:#334155; --accent:#0f9d58; --danger:#c62828; --card:#ffffff; --glass: rgba(2,6,23,0.02); color:#0b1220;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6f0fb}
  .wrap{max-width:1200px;margin:10px auto;padding:10px}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .left{display:flex;gap:8px;align-items:center;flex:1}
  .right{display:flex;gap:8px;align-items:center}
  input,select,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  .card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0));padding:10px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
  #chartRow{display:grid;grid-template-columns: 1fr 360px; gap:12px;margin-top:12px}
  @media(max-width:980px){ #chartRow{grid-template-columns:1fr} .right-col{order:2} .tvCard{height:48vh} }
  #tvContainer{height:66vh;border-radius:10px;overflow:hidden;background:var(--card)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .btn{cursor:pointer}
  #luminaHeart{position:fixed;right:20px;top:18px;width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,#ff758c,#7c5cff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;border:none;z-index:2000}
  #luminaPanel{position:fixed;right:0;top:0;height:100%;width:420px;max-width:95%;background:var(--panel);transform:translateX(110%);transition:transform .28s ease-in-out;z-index:1999;padding:12px;overflow:auto}
  #luminaPanel.open{transform:translateX(0)}
  .small{font-size:13px;color:var(--muted)}
  .signal{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
  .pairList{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
  .pairBtn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;text-align:left}
  .history{max-height:160px;overflow:auto;font-size:13px;color:var(--muted)}
  .chatArea{display:flex;flex-direction:column;gap:8px;max-height:72vh;overflow:auto;padding:6px}
  .bubble.you{background:rgba(255,255,255,0.04);align-self:flex-end;padding:10px;border-radius:10px;max-width:85%;color:inherit}
  .bubble.lumina{background:linear-gradient(90deg,#7c5cff,#ff758c);color:#fff;align-self:flex-start;padding:10px;border-radius:10px;max-width:85%}
  .controls input{min-width:100px}
  .mutedSmall{font-size:12px;color:var(--muted)}
</style>
</head>
<body data-theme="dark">
<div class="wrap">
  <div class="topbar">
    <div class="left card" style="flex:1;display:flex;gap:10px;align-items:center">
      <div>
        <div class="mutedSmall">Mode</div>
        <div id="modeBadge" class="small" style="font-weight:700">DEMO</div>
      </div>
      <div>
        <div class="mutedSmall">Balance</div>
        <div id="balanceVal" style="font-weight:700">$50,000.00</div>
      </div>
      <div>
        <div class="mutedSmall">Lot</div>
        <input id="lotTop" value="0.01" style="width:90px"/>
      </div>
      <div style="flex:1">
        <input id="pairSearch" placeholder="Search pair (EURUSD, BTCUSD...)" style="width:100%"/>
      </div>
      <select id="pairSelect" style="min-width:160px"></select>
      <select id="timeframe" title="Timeframe" style="width:110px">
        <option value="60">1m</option><option value="300">5m</option><option value="900">15m</option><option value="3600">1h</option><option value="14400">4h</option><option value="86400">1d</option><option value="604800">1w</option><option value="2592000">1M</option><option value="31536000">1Y</option>
      </select>
    </div>

    <div class="right">
      <input id="bridgeUrl" placeholder="Bridge URL (https://...)" style="width:300px"/>
      <input id="bridgeUser" placeholder="user" style="width:90px"/>
      <input id="bridgePass" placeholder="pass" type="password" style="width:110px"/>
      <button id="connectBridge" class="btn card">Connect Bridge</button>
      <button id="themeToggle" class="btn card">Theme</button>
    </div>
  </div>

  <div id="chartRow">
    <div>
      <div id="tvContainer" class="card tvCard">
        <div id="tv_chart_container" style="width:100%;height:100%"></div>
      </div>

      <div class="card controls" style="margin-top:12px;align-items:center">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="buyBtn" class="btn" style="background:#072a18;color:var(--accent)">BUY</button>
          <button id="sellBtn" class="btn" style="background:#2a0b0b;color:var(--danger)">SELL</button>
          <input id="slInput" placeholder="SL (price)" style="width:120px"/>
          <input id="tpInput" placeholder="TP (price)" style="width:120px"/>
          <button id="exitAll" class="btn" style="background:#5a3c00;color:#fff">EXIT ALL</button>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <label class="mutedSmall">Mode</label>
          <select id="autoManual"><option value="auto">AUTO</option><option value="manual">MANUAL</option></select>
          <label class="mutedSmall">ManualMin</label><input id="manualMin" type="number" value="95" style="width:70px"/>
          <label class="mutedSmall">AutoMin</label><input id="autoMin" type="number" value="100" style="width:70px"/>
          <label class="mutedSmall">Allow Auto Exec</label><input id="allowAutoExec" type="checkbox"/>
          <select id="indicator" style="width:240px"><option>RSI</option><option>MACD</option><option>VWAP</option></select>
          <button id="analyzeBtn" class="btn" style="background:#4c2fff;color:#fff">Analyze</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Signals</strong>
          <div style="display:flex;gap:8px">
            <button id="exportSignals" class="btn">Export</button>
            <button id="clearSignals" class="btn">Clear</button>
            <button id="toggleChartMarkers" class="btn">Toggle On-Chart</button>
          </div>
        </div>

        <div id="signalList" style="margin-top:10px;max-height:260px;overflow:auto"></div>
        <div style="margin-top:10px" class="history">
          <strong class="mutedSmall">History</strong>
          <div id="historyLog"></div>
        </div>
      </div>
    </div>

    <div class="right-col">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Quick Pairs</strong>
        </div>
        <div class="pairList" id="pairsQuick" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Account</strong>
        <div class="mutedSmall" style="margin-top:6px">Mode: <span id="accountMode">DEMO</span></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="switchDemo" class="btn">DEMO</button><button id="switchReal" class="btn">REAL</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Indicators</strong>
        <div class="mutedSmall" style="margin-top:6px">Add built-in or custom indicators (POC)</div>
        <div style="margin-top:8px"><select id="indAdd" style="width:100%"><option>RSI</option><option>MACD</option><option>SuperTrend</option><option>VWAP</option></select></div>
      </div>
    </div>
  </div>
</div>

<!-- Lumina heart button -->
<button id="luminaHeart" title="Open Lumina">â™¡</button>

<!-- Lumina full chat panel -->
<div id="luminaPanel" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">Lumina â€” Assistant</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="voiceMode">
        <option value="girlfriend">Girlfriend</option>
        <option value="pro">Professional</option>
      </select>
      <select id="ttsLang">
        <option value="en-US">English (US)</option>
        <option value="en-GB">English (UK)</option>
        <option value="fr-FR">FranÃ§ais</option>
        <option value="es-ES">EspaÃ±ol</option>
        <option value="ar-SA">Arabic</option>
      </select>
      <label class="small"><input id="speakOnText" type="checkbox"/> Speak</label>
      <button id="closeLumina" class="btn">Close</button>
    </div>
  </div>

  <div style="margin-top:8px">
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="luminaInput" placeholder="Ask Lumina..." style="flex:1"/>
      <button id="luminaSend" class="btn">Ask</button>
      <button id="luminaMic" class="btn">ðŸŽ¤</button>
    </div>

    <div id="luminaChat" class="chatArea card" style="margin-top:8px"></div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="fileUp" type="file" accept="image/*,.png,.jpg,.jpeg,.pdf"/>
      <button id="camOpen" class="btn">Camera</button>
      <button id="delHistory" class="btn">Delete Chat</button>
    </div>
  </div>
</div>

<script>
/*
  Lumina AI POC - Updated

  Key safety/behavior:
  1) Auto execution WILL NOT run unless user ran Analyze and allowed auto execution via checkbox.
  2) Analysis is simulated here but uses multiple heuristics (SMA/EMA/ATR) to produce a confidence number.
  3) Demo trades update balance and produce history with PnL.
  4) Remove intrusive chart badges; signals can be toggled on-chart (POC).
*/

/* ---------------------------
   Config constants
   --------------------------- */
const ANALYSIS_VALID_MS = 1000 * 60 * 7; // analysis valid for 7 minutes
const DEMO_START_BAL = 50000;
let lastAnalysis = { time:0, pair:null, result: null };

/* ---------------------------
   Pairs/timeframes fill
   --------------------------- */
const basePairs = ["EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD","EURGBP","EURJPY","GBPJPY","XAUUSD","BTCUSD","ETHUSD"];
const extras = ['CAD','CHF','AUD','NZD','JPY','GBP','EUR','USD','MXN','ZAR','SEK','NOK','TRY','BRL','INR','CNY','SGD','HKD','KRW','PLN','RUB'];
let pairs = [...basePairs];
for(let i=0;i<extras.length;i++){
  for(let j=0;j<extras.length;j++){
    if(i===j) continue;
    pairs.push(extras[i]+extras[j]);
  }
}
pairs = [...new Set(pairs)].slice(0,200);

/* populate UI */
const pairSelect = document.getElementById('pairSelect');
const pairsQuick = document.getElementById('pairsQuick');
pairs.slice(0,75).forEach(p=>{
  const o = document.createElement('option'); o.value = p; o.textContent = p.slice(0,3)+'/'+p.slice(3); pairSelect.appendChild(o);
  const b = document.createElement('button'); b.className='pairBtn'; b.textContent = p.slice(0,3)+'/'+p.slice(3); b.addEventListener('click', ()=>{ pairSelect.value=p; refreshChart(); }); pairsQuick.appendChild(b);
});
pairSelect.value = 'EURUSD';

/* indicators placeholder */
const indSel = document.getElementById('indicator');
["RSI","MACD","EMA","SMA","ATR","VWAP","SuperTrend"].forEach(i=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=i; indSel.appendChild(opt); });

/* ---------------------------
   TradingView widget
   --------------------------- */
let tvWidget = null;
function mapInterval(tf){
  if(tf==='60') return '1';
  if(tf==='300') return '5';
  if(tf==='900') return '15';
  if(tf==='3600') return '60';
  if(tf==='14400') return '240';
  if(tf==='86400') return 'D';
  if(tf==='604800') return 'W';
  if(tf==='2592000') return 'M';
  return tf;
}
function createTV(symbol, tf){
  try{ if(tvWidget && tvWidget.remove) tvWidget.remove(); }catch(e){}
  const tvSymbol = (symbol && symbol.length===6) ? 'FX:'+symbol : symbol;
  const opts = {
    symbol: tvSymbol||'FX:EURUSD',
    container_id: "tv_chart_container",
    library_path: "https://s3.tradingview.com/",
    locale: "en",
    autosize: true,
    interval: mapInterval(tf),
    theme: (document.body.getAttribute('data-theme')==='dark' ? 'Dark' : 'Light'),
    overrides:{
      "mainSeriesProperties.candleStyle.upColor": "#39d353",
      "mainSeriesProperties.candleStyle.downColor": "#ff4d4f"
    }
  };
  tvWidget = new TradingView.widget(opts);
}

/* initialize chart */
createTV(pairSelect.value, document.getElementById('timeframe').value);
pairSelect.addEventListener('change', ()=>createTV(pairSelect.value, document.getElementById('timeframe').value));
document.getElementById('timeframe').addEventListener('change', ()=>createTV(pairSelect.value, document.getElementById('timeframe').value));

/* ---------------------------
   Signals + analysis engine (POC)
   - Analysis step is REQUIRED for auto exec.
   - Analysis simulates reading history and returns structured result and confidence.
   --------------------------- */
let signals = []; // active signals
let history = []; // history entries
let showChartMarkers = false;

function renderSignals(){
  const el = document.getElementById('signalList'); el.innerHTML='';
  signals.forEach(s=>{
    const d = document.createElement('div'); d.className='signal';
    d.innerHTML = `
      <div style="max-width:65%">
        <div style="display:flex;gap:8px;align-items:center">
          <strong style="color:${s.type==='buy'?'#39d353':'#ff4d4f'}">${s.type.toUpperCase()}</strong>
          <div class="mutedSmall">${s.pair} â€¢ ${s.tf}s</div>
        </div>
        <div class="mutedSmall">Entry: ${s.price} â€¢ SL: ${s.sl} â€¢ TP: ${s.tp}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${s.confidence}%</div>
        <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:6px">
          ${document.getElementById('autoManual').value === 'manual' ? `<button class="btn" data-id="${s.id}" onclick="confirmManual(this.dataset.id)">CONFIRM</button>` : ''}
          <button class="btn" data-id="${s.id}" onclick="removeSignal(this.dataset.id)">Remove</button>
        </div>
      </div>`;
    el.appendChild(d);
  });
}

function addSignal(s){
  s.id = 'sig_'+Date.now()+'_'+Math.floor(Math.random()*999);
  signals.unshift(s);
  if(signals.length>200) signals.pop();
  renderSignals();
  if(showChartMarkers) addMarkerOnChart(s);
  // Auto-exec only if analysis valid and user allowed
  if(document.getElementById('autoManual').value==='auto' && document.getElementById('allowAutoExec').checked){
    const autoMin = parseInt(document.getElementById('autoMin').value || 100);
    const now = Date.now();
    if(lastAnalysis && lastAnalysis.time > (now - ANALYSIS_VALID_MS) && lastAnalysis.pair === s.pair){
      // analysis present for this pair â€” check confidence
      if(s.confidence >= autoMin){
        sendToBridge({...s, ea_id:'lumina_ea_01', cmd:s.type});
      }
    } else {
      // no recent analysis â€” do not auto-execute
      console.log('Auto suppressed â€” no recent analysis for', s.pair);
    }
  }
}

function removeSignal(id){
  signals = signals.filter(x=>x.id!==id);
  renderSignals();
}

function confirmManual(id){
  const s = signals.find(x=>x.id===id);
  if(!s) return alert('Signal not found');
  if(!confirm(`Confirm ${s.type.toUpperCase()} ${s.pair} @ ${s.price} ?`)) return;
  sendToBridge({...s, ea_id:'lumina_ea_01', cmd:s.type, manual:true});
}

/* Simulated "deep analysis" â€” uses naive indicator heuristics to return structured object.
   In production replace this with server-side analysis that uses real historical data and news.
*/
async function runDeepAnalysis(pair, tf){
  // show "analyzing" UI
  const analyzeBtn = document.getElementById('analyzeBtn');
  analyzeBtn.textContent = 'Analyzing...';
  analyzeBtn.disabled = true;
  // simulate longer analysis
  await new Promise(r=>setTimeout(r, 1800 + Math.random()*1600));

  // fake heuristics â€” create SMA/EMA/ATR-like values (purely simulated)
  const smaShort = 1 + ((Math.random()-0.5) * 0.01);
  const smaLong  = smaShort + ((Math.random()-0.5) * 0.008);
  const atr = 0.001 + Math.random()*0.003;
  const volSpike = Math.random() > 0.7;
  // score building: trend + volatility + volSpike influences confidence
  let score = 50;
  if(smaShort > smaLong) score += 25; else score -= 8;
  score += Math.round((1/atr) * 2);
  if(volSpike) score += 10;
  // cap 60..110 for our POC
  score = Math.max(60, Math.min(110, score));
  // decide direction
  const dir = (smaShort > smaLong) ? 'buy' : 'sell';

  // Build recommended entry/SL/TP: simulated
  const price = (1 + Math.random()*0.02).toFixed(5);
  const sl = (parseFloat(price) + (dir==='buy' ? -atr : atr)).toFixed(5);
  const tp = (parseFloat(price) + (dir==='buy' ? (atr*3) : (-atr*3))).toFixed(5);

  // Save analysis
  const result = { pair, tf, dir, confidence: score, price, sl, tp, timestamp: Date.now(), notes: volSpike ? 'vol spike' : 'no spike' };
  lastAnalysis = { time: Date.now(), pair: pair, result: result };

  analyzeBtn.textContent = 'Analyze';
  analyzeBtn.disabled = false;

  return result;
}

/* When user clicks Analyze â†’ create high-quality signal (if confidence high) */
document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
  const p = pairSelect.value; const tf = document.getElementById('timeframe').value;
  const res = await runDeepAnalysis(p, tf);
  // show chat-like assistant feedback
  appendLuminaChat(`Analysis (${p} ${tf}s): ${res.dir.toUpperCase()} conf ${res.confidence}% â€” ${res.notes}`);
  // If high confidence recommend a signal
  if(res.confidence >= parseInt(document.getElementById('manualMin').value || 95)){
    // push recommended signal (manual by default if user set Manual mode)
    const manualMode = document.getElementById('autoManual').value === 'manual';
    const sig = { pair: p, tf: tf, type: res.dir, price: res.price, sl: res.sl, tp: res.tp, confidence: Math.round(res.confidence), time: Date.now(), manual: manualMode };
    addSignal(sig);
  } else {
    appendLuminaChat(`Lumina: confidence ${res.confidence}% â€” below manual threshold, will not auto-execute.`);
  }
});

/* Auto-simulated signal generator is heavily reduced now (we won't spam auto trades).
   For demo we still generate some low-confidence signals occasionally but they won't auto-exec without analysis.
*/
setInterval(()=>{
  // create occasional low-confidence signals for demo (won't auto-exec unless analyzed)
  const p = pairSelect.value;
  if(Math.random() < 0.18){
    const dir = Math.random()>0.5 ? 'buy' : 'sell';
    const price = (1 + Math.random()*0.02).toFixed(5);
    const sl = (parseFloat(price) + (dir==='buy' ? -0.002 : 0.002)).toFixed(5);
    const tp = (parseFloat(price) + (dir==='buy' ? 0.004 : -0.004)).toFixed(5);
    const conf = 60 + Math.floor(Math.random()*30);
    addSignal({ pair:p, tf: document.getElementById('timeframe').value, type:dir, price, sl, tp, confidence:conf, time: Date.now(), manual:false });
  }
}, 9000);

/* ---------------------------
   Send to Bridge / simulate trade
   --------------------------- */
async function sendToBridge(body){
  // body contains: pair,type,price,sl,tp,confidence,manual,ea_id...
  const url = window.BRIDGE_URL || document.getElementById('bridgeUrl').value.trim();
  const user = window.BRIDGE_USER || document.getElementById('bridgeUser').value.trim();
  const pass = window.BRIDGE_PASS || document.getElementById('bridgePass').value.trim();

  // If no bridge configured, run demo simulation locally
  if(!url){
    simulateOpenTrade(body);
    return { ok:true, simulated:true };
  }

  try{
    const res = await fetch(url + '/api/trade', {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization': 'Basic ' + btoa(user + ':' + pass) },
      body: JSON.stringify(body)
    });
    const j = await res.json();
    if(j && j.ok){
      simulateOpenTrade(body); // locally reflect it in UI as well
      return j;
    } else {
      alert('Bridge rejected: ' + JSON.stringify(j));
      return j;
    }
  }catch(e){
    console.warn('bridge fail', e);
    alert('Failed to reach Bridge â€” trade simulated locally (demo).');
    simulateOpenTrade(body);
    return { ok:false, error:e.toString() };
  }
}

/* simulation: open trade locally and update history & demo balance
   PnL probability is tied to confidence: higher confidence â†’ higher chance of win and more pnl
*/
function simulateOpenTrade(body){
  const now = Date.now();
  const trade = { id:'T'+now, pair:body.pair, cmd: body.cmd || body.type, vol: parseFloat(body.volume || document.getElementById('lotTop').value || 0.01), price: body.price || (1 + Math.random()*0.02).toFixed(5), sl: body.sl || body.sl, tp: body.tp || body.tp, time: now, confidence: body.confidence || 80 };
  // push open record
  history.unshift({ ...trade, status:'open', note:'opened', time:now });
  renderHistory();

  // simulate close after 6-12s with probability depending on confidence
  setTimeout(()=>{
    const conf = trade.confidence;
    // winProb ~ (conf - 50)/60 clamp 0.05..0.95
    let winProb = Math.max(0.05, Math.min(0.95, (conf - 55) / 55 ));
    const win = Math.random() < winProb;
    // pnl magnitude depends on vol and confidence
    const basePnL = trade.vol * (win ? 30 : -30) * (0.5 + Math.random() * (conf/100));
    const pnl = parseFloat(basePnL.toFixed(2));
    history.unshift({ ...trade, status: win ? 'win' : 'loss', pnl: pnl, closedAt: Date.now() });
    // update demo balance
    if(document.getElementById('accountMode').textContent === 'DEMO'){
      const cur = parseFloat(document.getElementById('balanceVal').textContent.replace(/[^0-9.-]+/g,""));
      const newBal = cur + pnl;
      document.getElementById('balanceVal').textContent = '$' + newBal.toFixed(2);
    }
    renderHistory();
  }, 7000 + Math.random()*5000);
}

/* render history */
function renderHistory(){
  const el = document.getElementById('historyLog'); el.innerHTML='';
  history.slice(0,80).forEach(h=>{
    const d = document.createElement('div'); d.className='mutedSmall';
    const when = new Date(h.time || h.closedAt).toLocaleString();
    d.textContent = `${when} Â· ${h.pair} Â· ${h.cmd} Â· ${h.status || ''} ${h.pnl ? ' Â· pnl '+h.pnl : ''}`;
    el.appendChild(d);
  });
}

/* On-chart markers (small, non-intrusive) */
function addMarkerOnChart(s){
  if(!showChartMarkers) return;
  try{
    const c = document.getElementById('tv_chart_container');
    const badge = document.createElement('div');
    badge.style.position='absolute'; badge.style.right='8px'; badge.style.top=(20 + Math.random()*200)+'px';
    badge.style.padding='4px 6px'; badge.style.fontSize='12px'; badge.style.borderRadius='8px'; badge.style.zIndex=1200;
    badge.style.background = s.type==='buy' ? 'rgba(57,211,83,0.12)' : 'rgba(255,77,79,0.10)';
    badge.style.color = s.type==='buy' ? '#39d353' : '#ff4d4f';
    badge.textContent = `${s.type.toUpperCase()} ${s.confidence}%`;
    badge.id = 'badge_' + s.id;
    c.appendChild(badge);
    setTimeout(()=>badge.remove(), 24000);
  }catch(e){}
}

/* ---------------------------
   UI wiring
   --------------------------- */
document.getElementById('buyBtn').addEventListener('click', ()=>{
  const p = pairSelect.value;
  const price = (1 + Math.random()*0.02).toFixed(5);
  const sl = document.getElementById('slInput').value || (parseFloat(price)-0.002).toFixed(5);
  const tp = document.getElementById('tpInput').value || (parseFloat(price)+0.004).toFixed(5);
  const conf = parseInt(document.getElementById('manualMin').value||95);
  addSignal({ pair:p, tf:document.getElementById('timeframe').value, type:'buy', price:price, sl:sl, tp:tp, confidence:conf, manual:true });
});
document.getElementById('sellBtn').addEventListener('click', ()=>{
  const p = pairSelect.value;
  const price = (1 + Math.random()*0.02).toFixed(5);
  const sl = document.getElementById('slInput').value || (parseFloat(price)+0.002).toFixed(5);
  const tp = document.getElementById('tpInput').value || (parseFloat(price)-0.004).toFixed(5);
  const conf = parseInt(document.getElementById('manualMin').value||95);
  addSignal({ pair:p, tf:document.getElementById('timeframe').value, type:'sell', price:price, sl:sl, tp:tp, confidence:conf, manual:true });
});

document.getElementById('clearSignals').addEventListener('click', ()=>{ signals = []; renderSignals(); });
document.getElementById('exportSignals').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(signals,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='lumina_signals.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('toggleChartMarkers').addEventListener('click', ()=>{ showChartMarkers = !showChartMarkers; alert('Chart markers: '+showChartMarkers); });

document.getElementById('allowAutoExec').checked = false; // default off

/* connect bridge (front-end store) */
document.getElementById('connectBridge').addEventListener('click', ()=>{
  window.BRIDGE_URL = document.getElementById('bridgeUrl').value.trim();
  window.BRIDGE_USER = document.getElementById('bridgeUser').value.trim();
  window.BRIDGE_PASS = document.getElementById('bridgePass').value.trim();
  alert('Bridge stored in front-end (demo). Must be server-side for production.');
});

/* theme toggle (fix signal panel visibility) */
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const el = document.body;
  const t = el.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  el.setAttribute('data-theme', t);
  // re-create TV to apply theme
  createTV(pairSelect.value, document.getElementById('timeframe').value);
});

/* demo/real quick */
document.getElementById('switchDemo').addEventListener('click', ()=>{
  document.getElementById('accountMode').textContent = 'DEMO';
  document.getElementById('balanceVal').textContent = '$' + DEMO_START_BAL.toFixed(2);
});
document.getElementById('switchReal').addEventListener('click', ()=>{
  document.getElementById('accountMode').textContent = 'REAL';
  // Real mode doesn't change balance here - real bridge will handle
});

/* exit all (simulated) */
document.getElementById('exitAll').addEventListener('click', ()=>{
  if(confirm('Exit ALL open demo trades?')) {
    // convert open history to closed (simulated)
    history = history.map(h => ({...h, status: h.status === 'open' ? 'closed' : h.status }));
    renderHistory();
    alert('All demo trades closed (simulated).');
  }
});

/* pair search */
document.getElementById('pairSearch').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toUpperCase();
  pairSelect.innerHTML = '';
  pairs.filter(p=>p.includes(q)).slice(0,120).forEach(p=>{
    const opt = document.createElement('option'); opt.value=p; opt.textContent=p.slice(0,3)+'/'+p.slice(3); pairSelect.appendChild(opt);
  });
});

/* small: recalc TV on interval to prevent rendering issues */
setInterval(()=>{ try{ if(tvWidget && tvWidget.activeChart) tvWidget.activeChart().resize(); }catch(e){} }, 2500);

/* ---------------------------
   Lumina assistant (full panel)
   --------------------------- */
const luminaHeart = document.getElementById('luminaHeart');
const luminaPanel = document.getElementById('luminaPanel');
luminaHeart.addEventListener('click', ()=>luminaPanel.classList.toggle('open'));
document.getElementById('closeLumina').addEventListener('click', ()=>luminaPanel.classList.remove('open'));

const luminaChat = document.getElementById('luminaChat');
function appendLuminaChat(txt, who='Lumina'){
  const div = document.createElement('div'); div.className = who==='You' ? 'bubble you' : 'bubble lumina';
  div.textContent = txt; luminaChat.appendChild(div); luminaChat.scrollTop = luminaChat.scrollHeight;
}

document.getElementById('luminaSend').addEventListener('click', ()=>{
  const q = (document.getElementById('luminaInput').value || '').trim();
  if(!q) return;
  appendLuminaChat(q, 'You');
  document.getElementById('luminaInput').value = '';
  setTimeout(()=>luminaAnswer(q), 500 + Math.random()*900);
});

function luminaAnswer(q){
  const mode = document.getElementById('voiceMode').value;
  // if ask for analyze
  if(/analyz|scan|levels|order block|smart money/i.test(q)){
    appendLuminaChat(`Lumina (${mode}): Running deep scan on ${pairSelect.value}. Please use Analyze button for thorough checking and recommendations.`);
    if(document.getElementById('speakOnText').checked) speakText(`I am scanning ${pairSelect.value}. I will look for institutional levels and order blocks.`);
    return;
  }
  // girlfriend style playful replies
  if(mode === 'girlfriend' && /hi|hello|love|baby/i.test(q)){
    appendLuminaChat(`Lumina (girlfriend): Hi baby ðŸ˜˜ â€” I'm watching the charts for you. Want me to run an analysis now?`);
    if(document.getElementById('speakOnText').checked) speakText('Hi baby. I am watching the charts for you.');
    return;
  }
  // generic
  appendLuminaChat(`Lumina (${mode}): I heard: "${q}". For chart analysis, press Analyze (it runs deep analysis and produces high-confidence signals).`);
  if(document.getElementById('speakOnText').checked) speakText(q);
}

/* tts helper */
function speakText(text){
  try{
    const lang = document.getElementById('ttsLang').value || 'en-US';
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = lang;
    const voices = speechSynthesis.getVoices();
    // pick an English voice if available otherwise first voice
    let v = voices.find(vv => vv.lang && vv.lang.startsWith(lang.split('-')[0]));
    if(v) utter.voice = v;
    utter.pitch = document.getElementById('voiceMode').value === 'girlfriend' ? 1.1 : 1.0;
    utter.rate = 1;
    speechSynthesis.speak(utter);
  }catch(e){ console.warn('TTS error', e); }
}

/* speech recognition for lumina input (if available) */
document.getElementById('luminaMic').addEventListener('click', ()=>{
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition) return alert('SpeechRecognition not supported by browser.');
  const r = new SpeechRecognition();
  r.lang = (document.getElementById('ttsLang').value || 'en-US');
  r.onresult = (ev) => { document.getElementById('luminaInput').value = ev.results[0][0].transcript; document.getElementById('luminaSend').click(); };
  r.onerror = ()=>alert('Speech error'); r.start();
});

/* delete assistant chat */
document.getElementById('delHistory').addEventListener('click', ()=>{ if(confirm('Clear assistant chat?')) luminaChat.innerHTML=''; });

/* camera - show preview in chat */
document.getElementById('camOpen').addEventListener('click', async ()=>{
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    const v = document.createElement('video'); v.autoplay=true; v.muted=true; v.playsInline=true; v.style.maxWidth='100%'; v.srcObject = s;
    luminaChat.appendChild(v); luminaChat.scrollTop = luminaChat.scrollHeight;
  }catch(e){ alert('camera error'); }
});

/* file upload - add link to chat */
document.getElementById('fileUp').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  appendLuminaChat('Uploaded file: ' + (f.name || 'file'), 'Lumina');
});

/* ---------------------------
   Small initial render
   --------------------------- */
renderSignals();
renderHistory();

</script>
</body>
</html>
