<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lumina AI â€” Max Power (Trading + Assistant)</title>
<meta name="description" content="Lumina AI Max â€” TradingView charts, 100+ forex pairs, manual+auto, assistant (voice/cam/file), demo/real bridge" />
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
  :root{
    --bg:#071023; --panel:#071428; --muted:#9fb0c8; --accent:#39d353; --danger:#ff4d4f;
    --card:#0b1a2a; --glass: rgba(255,255,255,0.02);
  }
  [data-theme="light"]{ --bg:#f8fafc; --panel:#ffffff; --muted:#334155; --accent:#0f9d58; --danger:#c62828; --card:#ffffff; --glass: rgba(2,6,23,0.02); color: #0b1220; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color: #e6f0fb}
  .wrap{max-width:1200px;margin:10px auto;padding:10px}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .left{display:flex;gap:8px;align-items:center;flex:1}
  .right{display:flex;gap:8px;align-items:center}
  input,select,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  .card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0));padding:10px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
  #chartRow{display:grid;grid-template-columns: 1fr 360px; gap:12px;margin-top:12px}
  @media(max-width:980px){ #chartRow{grid-template-columns:1fr} .right-col{order:2} .tvCard{height:48vh} }
  #tvContainer{height:66vh;border-radius:10px;overflow:hidden;background:var(--card)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .btn{cursor:pointer}
  #luminaBtn{position:fixed;right:20px;bottom:20px;width:58px;height:58px;border-radius:12px;background:linear-gradient(90deg,#ff758c,#7c5cff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;border:none;z-index:2000}
  #luminaPanel{position:fixed;right:0;top:0;height:100%;width:420px;max-width:95%;background:var(--panel);transform:translateX(110%);transition:transform .28s ease-in-out;z-index:1999;padding:12px;overflow:auto}
  #luminaPanel.open{transform:translateX(0)}
  .small{font-size:13px;color:var(--muted)}
  .signal{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between}
  .pairList{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
  .pairBtn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;text-align:left}
  .pill{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent}
  .history{max-height:160px;overflow:auto;font-size:13px;color:var(--muted)}
  .chatRow{display:flex;gap:8px;align-items:center;margin-top:8px}
  .bubble.you{background:rgba(255,255,255,0.04);align-self:flex-end;padding:8px;border-radius:10px;max-width:85%}
  .bubble.lumina{background:linear-gradient(90deg,#7c5cff,#ff758c);color:#fff;align-self:flex-start;padding:8px;border-radius:10px;max-width:85%}
  .chatArea{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding:6px}
  .toggle{display:inline-flex;align-items:center;gap:6px}
  .indicatorSelect{width:100%}
</style>
</head>
<body data-theme="dark">
<div class="wrap">
  <div class="topbar">
    <div class="left card" style="flex:1;display:flex;gap:10px;align-items:center">
      <div>
        <div class="small">Mode</div>
        <div id="modeBadge" class="pill">DEMO</div>
      </div>
      <div>
        <div class="small">Balance</div>
        <div id="balanceVal" style="font-weight:700">$50,000.00</div>
      </div>
      <div>
        <div class="small">Lot</div>
        <input id="lotTop" value="0.01" style="width:90px"/>
      </div>
      <div style="flex:1">
        <input id="pairSearch" placeholder="Search pair (EUR,USD,BTC...)" style="width:100%"/>
      </div>
      <select id="pairSelect" style="min-width:160px"></select>
      <select id="timeframe" title="Timeframe" style="width:110px">
        <option value="1">1s</option><option value="60" selected>1m</option><option value="300">5m</option><option value="900">15m</option><option value="3600">1h</option><option value="14400">4h</option><option value="86400">1d</option><option value="604800">1w</option>
      </select>
    </div>

    <div class="right">
      <input id="bridgeUrl" placeholder="Bridge URL (https://...)" style="width:300px"/>
      <input id="bridgeUser" placeholder="user" style="width:90px"/>
      <input id="bridgePass" placeholder="pass" type="password" style="width:110px"/>
      <button id="connectBridge" class="btn card">Connect Bridge</button>
      <button id="themeToggle" class="btn card">Theme</button>
      <button id="demoRealToggle" class="btn card">DEMO / REAL</button>
    </div>
  </div>

  <div id="chartRow">
    <div>
      <div id="tvContainer" class="card tvCard">
        <div id="tv_chart_container" style="width:100%;height:100%"></div>
      </div>

      <div class="card controls" style="margin-top:12px;align-items:center">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="buyBtn" class="btn" style="background:#072a18;color:var(--accent)">BUY</button>
          <button id="sellBtn" class="btn" style="background:#2a0b0b;color:var(--danger)">SELL</button>
          <input id="slInput" placeholder="SL (price)" style="width:120px"/>
          <input id="tpInput" placeholder="TP (price)" style="width:120px"/>
          <button id="exitAll" class="btn" style="background:#5a3c00;color:#fff">EXIT ALL</button>
        </div>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <label class="small">Mode</label>
          <select id="autoManual"><option value="auto">AUTO</option><option value="manual">MANUAL</option></select>
          <label class="small">ManualMin</label><input id="manualMin" type="number" value="95" style="width:70px"/>
          <label class="small">AutoMin</label><input id="autoMin" type="number" value="100" style="width:70px"/>
          <select id="indicator" class="indicatorSelect" style="width:240px"><option>Loading indicators...</option></select>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Signals</strong>
          <div style="display:flex;gap:8px">
            <button id="exportSignals" class="btn">Export</button>
            <button id="clearSignals" class="btn">Clear</button>
            <button id="toggleChartMarkers" class="btn">Toggle On-Chart</button>
          </div>
        </div>

        <div id="signalList" style="margin-top:10px;max-height:260px;overflow:auto"></div>
        <div style="margin-top:10px" class="history">
          <strong class="small">History</strong>
          <div id="historyLog"></div>
        </div>
      </div>
    </div>

    <div class="right-col">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Pairs â€” Quick</strong>
          <button id="showPairs" class="btn small">Show</button>
        </div>
        <div class="pairList" id="pairsQuick" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Account</strong>
        <div class="small">Mode: <span id="accountMode">DEMO</span> â€¢ Balance: <span id="accountBal">$50,000.00</span></div>
        <div style="margin-top:8px;display:flex;gap:8px"><button id="switchDemo" class="btn">DEMO</button><button id="switchReal" class="btn">REAL</button></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Indicators</strong>
        <div class="small" style="margin-top:6px">Add built-in or custom indicators (POC)</div>
        <div style="margin-top:8px"><select id="indAdd" style="width:100%"><option>RSI</option><option>MACD</option><option>SuperTrend</option><option>VWAP</option></select></div>
      </div>
    </div>
  </div>
</div>

<!-- Lumina assistant button -->
<button id="luminaBtn" title="Open Lumina">Lâ™¡</button>

<!-- Lumina panel -->
<div id="luminaPanel" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">Lumina â€” Assistant</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="voiceMode"><option value="girlfriend">Girlfriend</option><option value="pro">Professional</option></select>
      <label class="toggle small"><input id="speakOnText" type="checkbox"/> Speak on text</label>
      <button id="closeLumina" class="btn">Close</button>
    </div>
  </div>

  <div style="margin-top:8px">
    <div class="chatRow">
      <input id="luminaInput" placeholder="Ask Lumina..." style="flex:1"/>
      <button id="luminaSend" class="btn">Ask</button>
      <button id="luminaMic" class="btn">ðŸŽ¤</button>
    </div>

    <div class="chatArea card" id="luminaChat"></div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="fileUp" type="file" accept="image/*,.png,.jpg,.jpeg,.pdf"/>
      <button id="camOpen" class="btn">Camera</button>
      <button id="delHistory" class="btn">Delete Chat</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   Basic data & UI init
   --------------------------- */
const pairs = [
  "EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD","EURGBP","EURJPY","GBPJPY",
  "AUDJPY","AUDCAD","AUDCHF","CADJPY","CHFJPY","EURAUD","EURNZD","GBPAUD","GBPCAD","GBPCHF",
  "USDSGD","USDHKD","USDMXN","USDZAR","USDNOK","USDSEK","USDTRY","USDBRL","EURCAD","EURCHF",
  "XAUUSD","XAGUSD","BTCUSD","ETHUSD"
];
// programmatic expand to >100
const extras = ['CAD','CHF','AUD','NZD','JPY','GBP','EUR','USD','MXN','ZAR','SEK','NOK','TRY','BRL','INR','CNY','SGD','HKD','KRW','PLN','RUB'];
for(let i=0;i<extras.length;i++){
  for(let j=0;j<extras.length;j++){
    if(i===j) continue;
    pairs.push(extras[i]+extras[j]);
  }
}
const uniquePairs = [...new Set(pairs)].slice(0,160);

// populate selects + quick pairs
const pairSelect = document.getElementById('pairSelect');
const pairsQuick = document.getElementById('pairsQuick');
uniquePairs.slice(0,60).forEach(p=>{
  const opt = document.createElement('option'); opt.value=p; opt.textContent = p.slice(0,3)+'/'+p.slice(3); pairSelect.appendChild(opt);
  const btn = document.createElement('button'); btn.className='pairBtn'; btn.textContent=p.slice(0,3)+'/'+p.slice(3); btn.addEventListener('click', ()=>{ pairSelect.value = p; refreshChart(); }); pairsQuick.appendChild(btn);
});

// indicators fill
const indSel = document.getElementById('indicator');
indSel.innerHTML = '';
const commonInd = ["RSI","MACD","Stochastic","Bollinger Bands","EMA","SMA","VWAP","ATR","ADX","CCI","OBV","Ichimoku","SuperTrend"];
commonInd.forEach(i=>{ const o = document.createElement('option'); o.value=i; o.textContent=i; indSel.appendChild(o); });
for(let k=1;k<=200;k++){ const o = document.createElement('option'); o.value='Custom '+k; o.textContent='Custom '+k; indSel.appendChild(o); }

/* ---------------------------
   TradingView widget create
   --------------------------- */
let tvWidget = null;
function mapInterval(tf){
  // returns TradingView-friendly interval
  if(tf==='1') return '1';
  if(tf==='60') return '1';
  if(tf==='300') return '5';
  if(tf==='900') return '15';
  if(tf==='3600') return '60';
  if(tf==='14400') return '240';
  if(tf==='86400') return 'D';
  if(tf==='604800') return 'W';
  return tf;
}
function createTV(symbol, tf){
  try{ if(tvWidget && tvWidget.remove) tvWidget.remove(); }catch(e){}
  const tvSymbol = (symbol && symbol.length===6) ? 'FX:'+symbol : symbol;
  const widgetOptions = {
    symbol: tvSymbol || 'FX:EURUSD',
    container_id: "tv_chart_container",
    library_path: "https://s3.tradingview.com/",
    locale: "en",
    autosize: true,
    interval: mapInterval(tf),
    theme: (document.body.getAttribute('data-theme')==='dark' ? 'Dark' : 'Light'),
    studies_overrides: {},
    overrides: {
      "mainSeriesProperties.candleStyle.upColor": "#39d353",
      "mainSeriesProperties.candleStyle.downColor": "#ff4d4f",
      "paneProperties.background": document.body.getAttribute('data-theme')==='dark' ? "#071023" : "#ffffff"
    },
  };
  tvWidget = new TradingView.widget(widgetOptions);
}
function refreshChart(){ createTV(pairSelect.value, document.getElementById('timeframe').value); }

/* initial */
pairSelect.value = 'EURUSD';
refreshChart();

/* ---------------------------
   Signals engine (POC)
   - For production: replace with server historical + SMC logic
   --------------------------- */
let signals = []; // {id,pair,tf,type,price,sl,tp,confidence,time,auto}
let history = []; // closed/touched trades
let showChartMarkers = true;
const signalListElem = document.getElementById('signalList');
const historyElem = document.getElementById('historyLog');

function renderSignals(){
  signalListElem.innerHTML = '';
  signals.forEach(s=>{
    const d = document.createElement('div'); d.className='signal';
    d.innerHTML = `
      <div style="max-width:65%">
        <div style="display:flex;gap:8px;align-items:center"><strong style="color:${s.type==='buy'?'#39d353':'#ff4d4f'}">${s.type.toUpperCase()}</strong>
        <div class="small">${s.pair} â€¢ ${s.tf}s</div></div>
        <div class="small">Entry: ${s.price} â€¢ SL: ${s.sl} â€¢ TP: ${s.tp}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${s.confidence}%</div>
        <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:6px">
          ${ document.getElementById('autoManual').value === 'manual' ? `<button class="btn" data-id="${s.id}" onclick="confirmManual(this.dataset.id)">CONFIRM</button>` : '' }
          <button class="btn" data-id="${s.id}" onclick="removeSignal(this.dataset.id)">Remove</button>
        </div>
      </div>`;
    signalListElem.appendChild(d);
  });
}

function pushSignal(s){
  s.id = 'sig_'+Date.now()+'_'+Math.floor(Math.random()*1000);
  signals.unshift(s);
  if(signals.length>200) signals.pop();
  renderSignals();
  if(showChartMarkers) addMarkerOnChart(s);
  // if auto and conf >= threshold then auto-exec
  if(!s.manual && document.getElementById('autoManual').value==='auto'){
    const autoMin = parseInt(document.getElementById('autoMin').value || 100);
    if(s.confidence >= autoMin) sendToBridge({...s, ea_id:'lumina_ea_01', cmd: s.type});
  }
}

// remove signal
function removeSignal(id){
  signals = signals.filter(x=>x.id!==id);
  renderSignals();
}

/* manual confirm */
async function confirmManual(id){
  const s = signals.find(x=>x.id===id);
  if(!s) return alert('Signal not found');
  // ask confirm popup
  if(!confirm(`Confirm ${s.type.toUpperCase()} ${s.pair} @ ${s.price} (SL ${s.sl} TP ${s.tp}) ?`)) return;
  sendToBridge({...s, ea_id:'lumina_ea_01', cmd: s.type, manual:true});
}

/* simulate algorithm: creates signals for demo every random interval â€” replace in production */
function generateDemoSignal(){
  const p = pairSelect.value || 'EURUSD';
  const tf = document.getElementById('timeframe').value;
  const type = Math.random()>0.5 ? 'buy' : 'sell';
  const price = (1 + Math.random()*0.02).toFixed(5);
  const sl = (parseFloat(price) + (type==='buy' ? -0.002 : 0.002)).toFixed(5);
  const tp = (parseFloat(price) + (type==='buy' ? 0.004 : -0.004)).toFixed(5);
  // Build confidence: manual must be high (simulate), auto may be lower
  const isManual = (document.getElementById('autoManual').value === 'manual');
  let conf = isManual ? (95 + Math.floor(Math.random()*6)) : (80 + Math.floor(Math.random()*41));
  if(conf>110) conf=110;
  // If user requested AutoMin = 100 treat accordingly
  const sig = { pair:p, tf:tf, type:type, price:price, sl:sl, tp:tp, confidence:conf, time: Date.now(), manual:isManual?true:false };
  pushSignal(sig);
}

/* various UI hooks */
document.getElementById('clearSignals').addEventListener('click', ()=>{ signals=[]; renderSignals(); });
document.getElementById('exportSignals').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(signals,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='lumina_signals.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('toggleChartMarkers').addEventListener('click', ()=>{ showChartMarkers = !showChartMarkers; alert('Toggle on-chart markers: '+ showChartMarkers); });

/* simulate repeated demo signals every 6-9s when in DEMO */
let demoInterval = setInterval(()=>{ if(document.getElementById('accountMode').textContent==='DEMO') generateDemoSignal(); }, 7000);

/* send to bridge (front-end demo). In production, Bridge must be server-side and secured */
async function sendToBridge(body){
  if(!window.BRIDGE_URL && !document.getElementById('bridgeUrl').value.trim()){
    // simulate trade result in demo locally
    simulateOpenTrade(body);
    return;
  }
  const url = window.BRIDGE_URL || document.getElementById('bridgeUrl').value.trim();
  const user = window.BRIDGE_USER || document.getElementById('bridgeUser').value.trim();
  const pass = window.BRIDGE_PASS || document.getElementById('bridgePass').value.trim();
  try{
    const res = await fetch(url + '/api/trade', {
      method:'POST', headers: {'Content-Type':'application/json', 'Authorization': 'Basic '+btoa(user+':'+pass)}, body: JSON.stringify(body)
    });
    const j = await res.json();
    if(j && j.ok){ alert('Bridge queued'); simulateOpenTrade(body); }
    else { alert('Bridge error: '+JSON.stringify(j)); }
  }catch(e){ console.warn('bridge fail',e); alert('Failed to contact bridge (check URL/credentials). For demo, trades simulated locally.'); }
}

/* simulation: open trade locally and update history & demo balance */
function simulateOpenTrade(body){
  const tradeId = 'T'+Date.now();
  const entry = { id:tradeId, pair: body.pair, cmd: body.cmd||body.type, volume: parseFloat(body.volume||document.getElementById('lotTop').value||0.01), price: body.price||body.price, sl: body.sl||document.getElementById('slInput').value||0, tp: body.tp||document.getElementById('tpInput').value||0, time: Date.now(), status:'open', confidence: body.confidence||0 };
  history.unshift({ ...entry, note: 'opened' });
  // adjust demo balance placeholder: wins/losses random after short time
  if(document.getElementById('accountMode').textContent==='DEMO'){
    const curBal = parseFloat(document.getElementById('accountBal').textContent.replace(/[^0-9.-]+/g,""));
    // simulate small PnL after 5-12s
    setTimeout(()=>{
      // random win or loss
      const win = Math.random()>0.45;
      const pnl = (entry.volume * (win ? 30 : -30)) * (Math.random()+0.5);
      const newBal = curBal + pnl;
      document.getElementById('accountBal').textContent = '$' + newBal.toFixed(2);
      history.unshift({ ...entry, status: win ? 'win' : 'loss', pnl: pnl.toFixed(2), closedAt: Date.now() });
      renderHistory();
    }, 9000 + Math.random()*6000);
  }
  renderHistory();
}

/* render history */
function renderHistory(){
  historyElem.innerHTML = '';
  history.slice(0,40).forEach(h=>{
    const div = document.createElement('div'); div.className='small'; div.textContent = `${new Date(h.time||h.closedAt).toLocaleString()} Â· ${h.pair} Â· ${h.cmd||h.volume} Â· ${h.status||h.note||''} ${h.pnl?('Â· pnl '+h.pnl):''}`;
    historyElem.appendChild(div);
  });
}

/* marker on chart (POC) - create overlay badges inside chart container */
function addMarkerOnChart(s){
  try{
    const c = document.getElementById('tv_chart_container');
    const badge = document.createElement('div');
    badge.style.position='absolute'; badge.style.right='12px'; badge.style.top= (40 + Math.random()*220) + 'px';
    badge.style.padding='6px 8px'; badge.style.borderRadius='8px'; badge.style.fontSize='13px'; badge.style.zIndex=1500;
    badge.style.background = s.type==='buy' ? 'rgba(57,211,83,0.12)' : 'rgba(255,77,79,0.12)';
    badge.style.color = s.type==='buy' ? '#39d353' : '#ff4d4f';
    badge.textContent = `${s.type.toUpperCase()} ${s.confidence}%`;
    badge.id = 'badge_'+s.id;
    c.appendChild(badge);
    // auto-remove after a while for demo
    setTimeout(()=>{ try{ badge.remove(); }catch(e){} }, 35000);
  }catch(e){}
}

/* ---------------------------
   Connect / UI event wiring
   --------------------------- */
document.getElementById('connectBridge').addEventListener('click', ()=>{
  window.BRIDGE_URL = document.getElementById('bridgeUrl').value.trim();
  window.BRIDGE_USER = document.getElementById('bridgeUser').value.trim();
  window.BRIDGE_PASS = document.getElementById('bridgePass').value.trim();
  alert('Bridge configured (front-end). For security, keep credentials server-side.');
});

// buy / sell manual UI: prefill a signal and if in manual mode create signal (then CONFIRM required)
document.getElementById('buyBtn').addEventListener('click', ()=>{
  const s = buildSignal('buy', true);
  pushSignal(s);
});
document.getElementById('sellBtn').addEventListener('click', ()=>{
  const s = buildSignal('sell', true);
  pushSignal(s);
});
function buildSignal(type, manualOverride=false){
  const p = pairSelect.value; const tf = document.getElementById('timeframe').value;
  const price = (1 + Math.random()*0.02).toFixed(5);
  const sl = document.getElementById('slInput').value || (type==='buy' ? (price - 0.002).toFixed(5) : (parseFloat(price) + 0.002).toFixed(5));
  const tp = document.getElementById('tpInput').value || (type==='buy' ? (parseFloat(price) + 0.004).toFixed(5) : (price - 0.004).toFixed(5));
  const conf = manualOverride ? parseInt(document.getElementById('manualMin').value||95) : 90;
  return { pair:p, tf:tf, type:type, price:price, sl:sl, tp:tp, confidence:conf, time:Date.now(), manual: (document.getElementById('autoManual').value==='manual') };
}

/* handle theme toggle */
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const el = document.body;
  if(el.getAttribute('data-theme')==='dark'){ el.setAttribute('data-theme','light'); } else { el.setAttribute('data-theme','dark'); }
  // recreate chart to apply theme properly
  refreshChart();
});

/* demo/real toggle */
document.getElementById('demoRealToggle').addEventListener('click', ()=>{
  const a = document.getElementById('accountMode');
  if(a.textContent==='DEMO'){ a.textContent='REAL'; document.getElementById('modeBadge').textContent='REAL'; } else { a.textContent='DEMO'; document.getElementById('modeBadge').textContent='DEMO'; }
});

/* switch demo/real quick */
document.getElementById('switchDemo').addEventListener('click', ()=>{ document.getElementById('accountMode').textContent='DEMO'; document.getElementById('accountBal').textContent='$50,000.00'; document.getElementById('modeBadge').textContent='DEMO'; });
document.getElementById('switchReal').addEventListener('click', ()=>{ document.getElementById('accountMode').textContent='REAL'; document.getElementById('modeBadge').textContent='REAL'; });

/* pair search quick */
document.getElementById('pairSearch').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toUpperCase();
  pairSelect.innerHTML = '';
  uniquePairs.filter(p=>p.includes(q)).slice(0,200).forEach(p=>{ const o = document.createElement('option'); o.value=p; o.textContent=p.slice(0,3)+'/'+p.slice(3); pairSelect.appendChild(o); });
});

/* pairs quick toggle */
document.getElementById('showPairs').addEventListener('click', ()=>{ document.querySelector('.pairList').scrollTop = 0; });

/* exit all - simulated */
document.getElementById('exitAll').addEventListener('click', ()=>{ if(confirm('Exit ALL open trades (demo simulated)?')){ // reduce history entries
  history.forEach(h=>{ if(h.status==='open') h.status='closed'; }); renderHistory(); alert('All demo trades closed (simulated).'); } });

/* pair/timeframe change -> refresh chart */
pairSelect.addEventListener('change', refreshChart);
document.getElementById('timeframe').addEventListener('change', refreshChart);

/* toggle lumina panel */
const luminaBtn = document.getElementById('luminaBtn');
const luminaPanel = document.getElementById('luminaPanel');
luminaBtn.addEventListener('click', ()=>luminaPanel.classList.toggle('open'));
document.getElementById('closeLumina').addEventListener('click', ()=>luminaPanel.classList.remove('open'));

/* lumina chat logic (POC replies) */
const luminaChat = document.getElementById('luminaChat');
function appendChat(who, text){
  const d = document.createElement('div');
  d.className = who==='You' ? 'bubble you' : 'bubble lumina';
  d.textContent = text;
  luminaChat.appendChild(d);
  luminaChat.scrollTop = luminaChat.scrollHeight;
}

document.getElementById('luminaSend').addEventListener('click', ()=>{ const q = document.getElementById('luminaInput').value.trim(); if(!q) return; appendChat('You', q); document.getElementById('luminaInput').value=''; setTimeout(()=>luminaReply(q),400); });
document.getElementById('delHistory').addEventListener('click', ()=>{ if(confirm('Delete assistant chat history?')) { luminaChat.innerHTML=''; } });

function luminaReply(q){
  const voiceMode = document.getElementById('voiceMode').value;
  // POC reply: emulate deep analysis when asked about chart or "analyze"
  if(/analyz|scan|levels|order block|smart money/i.test(q)){
    appendChat('Lumina', `Lumina (${voiceMode}): I scanned ${pairSelect.value} on ${document.getElementById('timeframe').value}s. Searching order blocks, liquidity and institutional levels. I will propose high-confidence setups.` );
  } else if(/hi|hello|love|baby/i.test(q) && voiceMode==='girlfriend'){
    appendChat('Lumina', `Lumina: Hi baby ðŸ’• â€” I missed you. Want me to analyze the open chart?`);
  } else {
    appendChat('Lumina', `Lumina (${voiceMode}): POC reply â€” I heard: "${q}". Ask me to analyze the chart, scan SMC, or request indicators.`);
  }
  // TTS if enabled
  if(document.getElementById('speakOnText').checked) speakText(luminaChat.lastChild.textContent);
}
function speakText(txt){
  try{
    const u = new SpeechSynthesisUtterance(txt);
    const voices = speechSynthesis.getVoices();
    // pick a friendly female-ish voice if available
    let v = voices.find(x=>x.lang && x.lang.startsWith('en') && /female|zira|susan|karen|alloy|amy/i.test(x.name)) || voices.find(x=>x.lang && x.lang.startsWith('en'));
    if(v) u.voice = v;
    u.pitch = 1.05; u.rate = 1; speechSynthesis.speak(u);
  }catch(e){ console.warn('tts',e); }
}

/* simple mic capture (browser support) */
document.getElementById('luminaMic').addEventListener('click', async ()=>{
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){ alert('SpeechRecognition not supported'); return; }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const r = new SR(); r.lang='en-US'; r.onresult = e=>{ const txt = e.results[0][0].transcript; document.getElementById('luminaInput').value = txt; document.getElementById('luminaSend').click(); };
  r.onerror = ()=>alert('Speech error'); r.start();
});

/* camera open (browser) - very simple */
document.getElementById('camOpen').addEventListener('click', async ()=>{
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    const v = document.createElement('video'); v.autoplay=true; v.playsinline=true; v.muted=true; v.style.maxWidth='100%'; v.srcObject = s;
    luminaChat.appendChild(v);
    luminaChat.scrollTop = luminaChat.scrollHeight;
  }catch(e){ alert('camera error'); }
});

/* bridge connect assignment */
document.getElementById('connectBridge').addEventListener('click', ()=>{
  window.BRIDGE_URL = document.getElementById('bridgeUrl').value.trim();
  window.BRIDGE_USER = document.getElementById('bridgeUser').value.trim();
  window.BRIDGE_PASS = document.getElementById('bridgePass').value.trim();
  alert('Bridge data stored in front-end (for demo). For production, store secrets server-side.');
});

/* small helper: periodically refresh TV because some browsers require resize */
setInterval(()=>{ try{ if(tvWidget && tvWidget.activeChart) tvWidget.activeChart().resize(); }catch(e){} }, 3000);

/* initial render */
renderSignals();
renderHistory();

</script>

</body>
</html>
