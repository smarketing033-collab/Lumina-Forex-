<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lumina AI v4 ‚Äî Trading (Auto + Manual) + Assistant</title>
<meta name="description" content="Lumina AI POC ‚Äî TradingView charts, 100+ forex pairs, indicators, auto/manual, Lumina assistant" />
<!-- TradingView official widget -->
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
  :root{
    --bg:#071023;--panel:#071428;--muted:#9fb0c8;--accent:#39d353;--danger:#ff4d4f;
    --card:#0b1a2a;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6f0fb}
  .top{display:flex;gap:8px;padding:10px;background:linear-gradient(90deg,#051129,#07182a);align-items:center;flex-wrap:wrap}
  select,input,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  .left-controls{display:flex;gap:8px;align-items:center}
  #balanceBox{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
  #chart-wrap{height:56vh;margin:12px;border-radius:10px;overflow:hidden}
  .panel{padding:12px;margin:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));box-shadow:0 8px 24px rgba(2,6,23,0.6)}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:transparent}
  #indicatorSelect{width:320px}
  #luminaOpen{position:fixed;right:18px;bottom:18px;width:66px;height:66px;border-radius:18px;background:linear-gradient(90deg,#ff758c,#7c5cff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;border:none;z-index:1200;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  #luminaSlide{position:fixed;right:0;top:0;height:100%;width:420px;max-width:95%;background:var(--panel);box-shadow:-20px 0 60px rgba(0,0,0,0.6);transform:translateX(100%);transition:transform .28s ease-in-out;z-index:1199;padding:12px;overflow:auto}
  #luminaSlide.open{transform:translateX(0)}
  .small{font-size:13px;color:var(--muted)}
  #pairSelect{min-width:170px}
  #timeframeSelect{width:92px}
  .signal{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;gap:12px}
  footer.note{color:var(--muted);font-size:13px;padding:12px;text-align:center}
  .badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-weight:700}
  .top-right-controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  @media(max-width:900px){ #luminaSlide{width:100%;} #chart-wrap{height:46vh} .top{padding:8px} }
  /* small helpers */
  .marker-buy{background:rgba(57,211,83,0.12);color:var(--accent);padding:6px;border-radius:6px}
  .marker-sell{background:rgba(255,77,79,0.09);color:var(--danger);padding:6px;border-radius:6px}
  .toggle{cursor:pointer;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02)}
  .right-bottom{position:fixed;right:18px;bottom:18px;z-index:100}
  .hidden{display:none}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="top">
  <div class="left-controls">
    <div id="balanceBox">
      <div>Mode: <span id="modeBadge" class="badge">DEMO</span></div>
      <div class="small">Balance: <span id="balanceVal">$50,000</span></div>
      <div class="small">Lot: <input id="topLot" value="0.01" style="width:80px"/></div>
    </div>

    <input id="pairSearch" placeholder="Search pairs (EUR,USD,BTC...)" style="min-width:180px"/>
    <select id="pairSelect"></select>

    <select id="timeframeSelect">
      <option value="1">1S</option>
      <option value="60" selected>1M</option>
      <option value="300">5M</option>
      <option value="900">15M</option>
      <option value="3600">1H</option>
      <option value="14400">4H</option>
      <option value="86400">1D</option>
      <option value="604800">1W</option>
      <option value="2592000">1M</option>
      <option value="31536000">1Y</option>
    </select>

    <!-- Remove timezone dropdown per your request (TradingView uses exchange zone) -->
  </div>

  <div class="top-right-controls">
    <input id="bridgeUrl" placeholder="Bridge URL (https://...)" style="width:300px"/>
    <input id="bridgeUser" placeholder="user" style="width:86px"/>
    <input id="bridgePass" placeholder="pass" type="password" style="width:110px"/>
    <button id="connectBtn" class="btn">Connect Bridge</button>

    <div style="display:flex;gap:6px;align-items:center">
      <button id="demoBtn" class="toggle">DEMO</button>
      <button id="realBtn" class="toggle">REAL</button>
      <button id="mobileToggle" class="toggle">Mobile Mode</button>
      <button id="themeToggle" class="toggle">Theme</button>
    </div>
  </div>
</div>

<!-- Chart -->
<div id="chart-wrap">
  <div id="tv_chart_container" style="width:100%;height:100%;"></div>
</div>

<!-- Controls panel -->
<div class="panel" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
  <div style="display:flex;gap:8px;align-items:center">
    <button id="buyBtn" class="btn" style="background:#072a18;color:var(--accent)">BUY</button>
    <button id="sellBtn" class="btn" style="background:#2a0b0b;color:var(--danger)">SELL</button>
    <input id="volume" placeholder="lot e.g. 0.01" style="width:110px"/>
    <input id="sl" placeholder="SL (price)" style="width:120px"/>
    <input id="tp" placeholder="TP (price)" style="width:120px"/>
    <button id="exitBtn" class="btn" style="background:#442a00;color:#ffd4a3">EXIT TRADE</button>
  </div>

  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <label class="small">Mode</label>
    <select id="modeSelect"><option value="auto">AUTO</option><option value="manual">MANUAL</option></select>
    <label class="small">ManualMin</label><input id="manualMin" type="number" value="95" style="width:72px"/>
    <label class="small">AutoMin</label><input id="autoMin" type="number" value="100" style="width:72px"/>
    <select id="indicatorSelect"><option>Loading indicators...</option></select>
    <button id="desktopView" class="btn">Desktop View</button>
  </div>
</div>

<!-- Signal panel -->
<div class="panel" style="max-width:1100px;margin:12px">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <strong>Live Signals</strong>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="exportBtn" class="btn">Export</button>
      <button id="clearBtn" class="btn">Clear</button>
    </div>
  </div>
  <div id="signalList" style="max-height:260px;overflow:auto;margin-top:8px"></div>
</div>

<!-- Lumina assistant open button (floating) -->
<button id="luminaOpen" title="Open Lumina">Lumina ‚ô•</button>

<!-- Lumina slide panel (assistant) -->
<div id="luminaSlide" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>Lumina ‚Äî Assistant</h3>
    <button id="luminaClose" class="btn">Close</button>
  </div>

  <div style="margin-top:8px">
    <input id="luminaInput" placeholder="Ask Lumina about the open chart..." style="width:100%;padding:8px;border-radius:8px"/>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <button id="luminaAsk" class="btn">Analyze (text)</button>
      <button id="luminaMic" class="btn">üé§ Speak</button>
      <label class="btn">üìÅ<input id="fileInput" type="file" accept="image/*,pdf" style="display:none"/></label>
      <button id="camBtn" class="btn">Camera</button>
      <button id="galleryBtn" class="btn">Gallery</button>
      <label class="btn"><input id="ttsToggle" type="checkbox" /> Assistant speaks on text?</label>
    </div>

    <div id="camWrap" style="margin-top:8px;display:none">
      <video id="camPreview" autoplay playsinline style="width:100%;border-radius:8px;background:#000"></video>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="snapBtn" class="btn">Snap</button>
        <button id="stopCam" class="btn">Stop</button>
      </div>
      <canvas id="snapCanvas" style="display:none"></canvas>
    </div>

    <div id="uploads" style="margin-top:8px"></div>

    <div id="luminaChat" style="margin-top:12px;max-height:420px;overflow:auto;border-top:1px solid rgba(255,255,255,0.04);padding-top:8px"></div>
  </div>
</div>

<footer class="note">Lumina AI POC ‚Äî demo balance $50,000. For production: deploy secure Bridge server + MT5 EA and keep secrets server-side only.</footer>

<script>
/* -----------------------
   PAIRS (100+), Indicators list & State
   ----------------------- */
const commonPairs = [
  "EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD","EURGBP","EURJPY","GBPJPY",
  "AUDJPY","AUDCAD","AUDCHF","CADJPY","CHFJPY","EURAUD","EURNZD","GBPAUD","GBPCAD","GBPCHF",
  "USDSGD","USDHKD","USDMXN","USDZAR","USDNOK","USDSEK","USDTRY","USDBRL","EURCAD","EURCHF",
  "XAUUSD","XAGUSD","BTCUSD","ETHUSD","LTCUSD","XRPUSD"
];
let pairs = Array.from(new Set(commonPairs));
const extras = ['CAD','CHF','AUD','NZD','JPY','GBP','EUR','USD','MXN','ZAR','SEK','NOK','TRY','BRL','INR','CNY','SGD','HKD','KRW','PLN','RUB'];
for(let i=0;i<extras.length;i++){
  for(let j=0;j<extras.length;j++){
    if(i===j) continue;
    pairs.push(extras[i]+extras[j]);
  }
}
pairs = Array.from(new Set(pairs)).slice(0,160);
const pairSelect = document.getElementById('pairSelect');
pairs.forEach(p=>{
  const o=document.createElement('option'); o.value=p; o.textContent = p.slice(0,3)+'/'+p.slice(3); pairSelect.appendChild(o);
});
document.getElementById('pairSearch').addEventListener('input', e=>{
  const q=e.target.value.trim().toUpperCase();
  pairSelect.innerHTML = '';
  pairs.filter(p=>p.includes(q)).forEach(p=>{
    const o=document.createElement('option'); o.value=p; o.textContent = p.slice(0,3)+'/'+p.slice(3); pairSelect.appendChild(o);
  });
});

// Indicators (simulated large list)
const indicatorSelect = document.getElementById('indicatorSelect');
const commonIndicators = ["RSI","MACD","Stochastic","Bollinger Bands","EMA","SMA","VWAP","ATR","ADX","CCI","OBV","Ichimoku","Parabolic SAR","Volume Profile","Momentum","ROC","Williams %R","SuperTrend","Donchian Channels","Hull MA","Fisher Transform"];
commonIndicators.forEach(i=>{ const o=document.createElement('option'); o.value=i; o.textContent=i; indicatorSelect.appendChild(o); });
for(let k=1;k<=500;k++){ const o=document.createElement('option'); o.value='Custom '+k; o.textContent='Custom '+k; indicatorSelect.appendChild(o); }

/* -----------------------
   TradingView Widget init
   (uses FX: prefix for forex; provider depends on TV account; may show demo watermark)
   ----------------------- */
let tvWidget = null;
function createTV(symbol='EURUSD', interval='60'){
  // remove existing
  try{ document.getElementById('tv_chart_container').innerHTML=''; }catch(e){}
  const widgetOptions = {
    symbol: (symbol.length===6?('FX:'+symbol):symbol),
    interval: mapIntervalToTV(interval),
    container_id: "tv_chart_container",
    library_path: "https://s3.tradingview.com/",
    locale: "en",
    disabled_features: ["use_localstorage_for_settings","left_toolbar"],
    enabled_features: ["study_templates","hide_last_na_sticker"],
    overrides: {
      "mainSeriesProperties.candleStyle.upColor": "#39d353",
      "mainSeriesProperties.candleStyle.downColor": "#ff4d4f",
      "mainSeriesProperties.candleStyle.borderUpColor": "#39d353",
      "mainSeriesProperties.candleStyle.borderDownColor": "#ff4d4f",
      "mainSeriesProperties.candleStyle.wickUpColor": "#39d353",
      "mainSeriesProperties.candleStyle.wickDownColor": "#ff4d4f"
    },
    theme: "Dark",
    toolbar_bg: "#0b1a2a",
    autosize: true,
    withdateranges: true
  };
  tvWidget = new TradingView.widget(widgetOptions);
}
function mapIntervalToTV(sec){
  const map = { '1':"1",'60':"1",'300':"5",'900':"15",'3600':"60",'14400':"240",'86400':"D",'604800':"W",'2592000':"M",'31536000':"M" };
  return map[sec] || (sec/60).toString();
}

/* -----------------------
   Markers & POC signal engine
   ----------------------- */
let signals = []; // stored signals
const maxSignalsStored = 500;
const signalList = document.getElementById('signalList');

function renderSignals(){
  signalList.innerHTML = '';
  signals.slice(0,80).forEach(s=>{
    const d = document.createElement('div'); d.className='signal';
    d.innerHTML = `
      <div>
        <div style="font-weight:700">${s.type.toUpperCase()} ‚Äî ${s.pair}</div>
        <div class="small">${new Date(s.time).toLocaleString()}</div>
        <div class="small">Notes: ${s.notes||'SMC/Orderblock/Vol'}</div>
      </div>
      <div style="text-align:right">
        <div>${+s.price}</div>
        <div class="small">TP:${s.tp||'‚Äî'} SL:${s.sl||'‚Äî'}</div>
        <div class="small">${s.confidence}%</div>
      </div>
    `;
    signalList.appendChild(d);
  });
}

/* Add buy/sell marker overlay to TradingView (TV markers require widget API; we add simple DOM label as fallback) */
function addLocalMarker(type, pxText){
  // create small floating label at top of signals panel (this is simpler for POC - TradingView official markers require chart API access)
  const el = document.createElement('div'); el.style.margin='6px'; el.className = type==='buy' ? 'marker-buy' : 'marker-sell';
  el.textContent = pxText;
  document.querySelector('#chart-wrap').appendChild(el);
  setTimeout(()=>el.remove(),6000);
}

/* naive analyzer for demo ‚Äî replace with real backtested engine that uses historical series (TwelveData or server) */
function analyzeAndMaybeSignal(pair){
  // POC: generate a strong manual signal occasionally and auto signals per autoMin
  const now = Date.now();
  const price = (1 + Math.random()*0.02).toFixed(5);
  const score = Math.floor(Math.random()*100); // simulated confidence
  // Manual mode: only push if >= manualMin
  const manualMin = parseInt(document.getElementById('manualMin').value || 95);
  if(score >= manualMin){
    const sig = {pair, type: Math.random()>0.5?'buy':'sell', price:+price, tp:(+price+0.01).toFixed(5), sl:(+price-0.01).toFixed(5), confidence: score, time: now, notes:'SMC+OrderBlock'};
    signals.unshift(sig);
    addLocalMarker(sig.type, `${sig.type.toUpperCase()} ${sig.confidence}%`);
  }
  // Auto execution
  const autoMin = parseInt(document.getElementById('autoMin').value || 100);
  const autoScore = Math.floor(Math.random()*100)+10; // 10..109
  if(autoScore >= autoMin){
    const body = { ea_id:'lumina_ea_01', cmd: Math.random()>0.5?'buy':'sell', symbol: pair, volume: parseFloat(document.getElementById('volume').value)||parseFloat(document.getElementById('topLot').value)||0.01, sl: parseFloat(document.getElementById('sl').value)||0, tp: parseFloat(document.getElementById('tp').value)||0, time: now, confidence:autoScore };
    // send to bridge if configured
    if(window.BRIDGE_URL && window.BRIDGE_USER){
      fetch(window.BRIDGE_URL + '/api/trade', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Basic '+btoa(window.BRIDGE_USER+':'+(window.BRIDGE_PASS||''))},
        body: JSON.stringify(body)
      }).then(r=>r.json()).then(j=>console.log('bridge queued',j)).catch(e=>console.warn('bridge send fail',e));
    }
    signals.unshift({pair, type: body.cmd, price:+price, tp:body.tp, sl:body.sl, confidence:autoScore, time: now, notes:'AutoExec'});
    addLocalMarker(body.cmd, `${body.cmd.toUpperCase()} ${autoScore}% (AUTO)`);
  }
  if(signals.length>maxSignalsStored) signals.length = maxSignalsStored;
  renderSignals();
}

/* simulate incoming candles every 7 seconds for POC (replace with real historical + streaming for production) */
let simInterval = setInterval(()=>{ analyzeAndMaybeSignal(pairSelect.value || 'EURUSD'); }, 7000);

/* -----------------------
   UI Actions: Connect / Buy / Sell / Exit
   ----------------------- */
document.getElementById('connectBtn').addEventListener('click', ()=>{
  window.BRIDGE_URL = document.getElementById('bridgeUrl').value.trim();
  window.BRIDGE_USER = document.getElementById('bridgeUser').value.trim();
  window.BRIDGE_PASS = document.getElementById('bridgePass').value.trim();
  if(window.BRIDGE_URL) alert('Bridge configured locally for front-end (POC). Remember: store secrets on server-side.');
});

async function sendTrade(side, manual=false){
  const body = {
    ea_id: 'lumina_ea_01',
    cmd: side,
    symbol: pairSelect.value,
    volume: parseFloat(document.getElementById('volume').value)||parseFloat(document.getElementById('topLot').value)||0.01,
    sl: parseFloat(document.getElementById('sl').value)||0,
    tp: parseFloat(document.getElementById('tp').value)||0,
    manual: !!manual,
    time: Date.now()
  };
  if(window.BRIDGE_URL && window.BRIDGE_USER){
    try{
      const res = await fetch(window.BRIDGE_URL + '/api/trade', {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':'Basic '+btoa(window.BRIDGE_USER+':'+(window.BRIDGE_PASS||''))},
        body: JSON.stringify(body)
      });
      const j = await res.json();
      alert(j.ok ? 'Trade queued' : 'Bridge error: ' + JSON.stringify(j));
    }catch(e){
      alert('Bridge send failed (check Bridge URL and server).');
    }
  } else {
    // demo fallback: show in signals/historic
    signals.unshift({pair: pairSelect.value, type: side, price: 'demo', tp: body.tp, sl: body.sl, confidence: (manual?95:100), time: Date.now(), notes: manual ? 'Manual (demo)' : 'Auto (demo)'});
    renderSignals();
    alert('Demo trade created (no bridge connected).');
  }
}

document.getElementById('buyBtn').addEventListener('click', ()=> {
  if(document.getElementById('modeSelect').value==='manual'){
    // manual mode: ask for confirm
    if(confirm('Confirm MANUAL BUY?')) sendTrade('buy', true);
  } else sendTrade('buy', false);
});
document.getElementById('sellBtn').addEventListener('click', ()=> {
  if(document.getElementById('modeSelect').value==='manual'){
    if(confirm('Confirm MANUAL SELL?')) sendTrade('sell', true);
  } else sendTrade('sell', false);
});
document.getElementById('exitBtn').addEventListener('click', async ()=>{
  // Exit trade: send exit command to bridge (EA should support)
  const body = { ea_id: 'lumina_ea_01', cmd: 'exit_all', time: Date.now() };
  if(window.BRIDGE_URL && window.BRIDGE_USER){
    try{
      const res = await fetch(window.BRIDGE_URL + '/api/trade', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Basic '+btoa(window.BRIDGE_USER+':'+(window.BRIDGE_PASS||''))}, body: JSON.stringify(body) });
      const j = await res.json();
      alert(j.ok ? 'Exit queued' : 'Bridge error: ' + JSON.stringify(j));
    }catch(e){ alert('Bridge exit failed'); }
  } else {
    alert('No bridge configured ‚Äî demo only.');
  }
});

/* export / clear */
document.getElementById('exportBtn').addEventListener('click', ()=> {
  const data = JSON.stringify(signals);
  const blob = new Blob([data],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='lumina_signals.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('clearBtn').addEventListener('click', ()=>{ signals=[]; renderSignals(); });

/* Demo/Real and toggles */
document.getElementById('demoBtn').addEventListener('click', ()=>{ document.getElementById('modeBadge').textContent='DEMO'; document.getElementById('balanceVal').textContent='$50,000'; });
document.getElementById('realBtn').addEventListener('click', ()=>{ document.getElementById('modeBadge').textContent='REAL'; document.getElementById('balanceVal').textContent='‚Äî'; alert('Switch to REAL: connect Bridge and EA for live trading'); });
document.getElementById('mobileToggle').addEventListener('click', ()=>{ document.body.classList.toggle('mobile'); alert('Toggled mobile mode (POC layout only)'); });
document.getElementById('themeToggle').addEventListener('click', ()=>{ const root=document.documentElement; if(root.style.getPropertyValue('--bg')===''){ root.style.setProperty('--bg','#ffffff'); root.style.setProperty('--panel','#f6f9ff'); root.style.setProperty('--muted','#334155'); document.body.style.color='#071023'; } else location.reload(); });
document.getElementById('desktopView').addEventListener('click', ()=>{ alert('Desktop view toggle (POC)'); });

/* Pair / timeframe changes -> refresh TV */
document.getElementById('pairSelect').addEventListener('change', ()=> refreshTV());
document.getElementById('timeframeSelect').addEventListener('change', ()=> refreshTV());
function refreshTV(){
  const sym = pairSelect.value;
  const tf = document.getElementById('timeframeSelect').value;
  createTV(sym, tf);
}

/* initialize TV */
createTV(pairSelect.value || 'EURUSD', document.getElementById('timeframeSelect').value);

/* -----------------------
   Lumina Assistant: camera, uploads, mic & TTS female
   ----------------------- */
const luminaOpen = document.getElementById('luminaOpen'), luminaSlide = document.getElementById('luminaSlide');
luminaOpen.addEventListener('click', ()=> luminaSlide.classList.toggle('open'));
document.getElementById('luminaClose').addEventListener('click', ()=> luminaSlide.classList.remove('open'));

const fileInput = document.getElementById('fileInput'), uploadsDiv = document.getElementById('uploads');
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const el = document.createElement('div'); el.innerHTML = `<div class="small">${f.name}</div><a href="${url}" target="_blank">Open</a>`; uploadsDiv.appendChild(el);
});

// camera
let stream=null;
document.getElementById('camBtn').addEventListener('click', async ()=>{
  const camWrap = document.getElementById('camWrap'); camWrap.style.display='block';
  try{ stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); document.getElementById('camPreview').srcObject = stream; }catch(e){ alert('Camera error'); }
});
document.getElementById('stopCam').addEventListener('click', ()=>{ if(stream){ stream.getTracks().forEach(t=>t.stop()); document.getElementById('camPreview').srcObject=null; stream=null; document.getElementById('camWrap').style.display='none'; }});
document.getElementById('snapBtn').addEventListener('click', ()=>{ const v=document.getElementById('camPreview'); const c=document.getElementById('snapCanvas'); c.width = v.videoWidth; c.height = v.videoHeight; const ctx=c.getContext('2d'); ctx.drawImage(v,0,0); c.style.display='block'; const url=c.toDataURL(); const img = document.createElement('img'); img.src=url; img.style.maxWidth='100%'; uploadsDiv.appendChild(img); alert('Captured'); });

// Microphone (Speech-to-text)
let recognition=null;
document.getElementById('luminaMic').addEventListener('click', async ()=>{
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){ alert('SpeechRecognition not supported in this browser'); return; }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.start();
  recognition.onresult = (e)=>{ const text = e.results[0][0].transcript; document.getElementById('luminaInput').value = text; document.getElementById('luminaAsk').click(); };
  recognition.onerror = (e)=>{ console.warn('recog err',e); alert('Speech error'); };
});

// Lumina analyze (POC) ‚Äî text replies + optional TTS female voice
document.getElementById('luminaAsk').addEventListener('click', ()=> {
  const q = document.getElementById('luminaInput').value.trim();
  if(!q) return;
  appendChat('You', q);
  setTimeout(()=> {
    // POC analysis: summary + sample actions; replace with server AI call for deep analysis
    const ans = `Lumina: Hi baby ‚Äî I looked at ${pairSelect.value} on ${document.getElementById('timeframeSelect').value}s. POC suggests check order blocks and liquidity. (This is demo analysis).`;
    appendChat('Lumina', ans);
    // speak if ttsToggle is checked OR query came from mic
    const ttsOn = document.getElementById('ttsToggle').checked;
    if(ttsOn) speakAsFemale(ans);
  }, 600);
});
function appendChat(who, msg){
  const d = document.createElement('div'); d.style.marginBottom='8px';
  d.innerHTML = `<strong>${who}</strong>: <div class="small">${msg}</div>`;
  document.getElementById('luminaChat').appendChild(d);
  document.getElementById('luminaChat').scrollTop = document.getElementById('luminaChat').scrollHeight;
}
function speakAsFemale(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    // pick any English voice (female-like if available)
    const female = voices.find(v=>/female|zira|samantha|victoria/i.test(v.name)) || voices.find(v=>v.lang && v.lang.startsWith('en')) || voices[0];
    if(female) u.voice = female;
    u.pitch = 1.05; u.rate = 1;
    speechSynthesis.speak(u);
  }catch(e){ console.warn('TTS fail', e); }
}

/* -----------------------
   Helpful console message
   ----------------------- */
console.log('Lumina AI v4 frontend loaded ‚Äî POC only. Replace simulated engines with server-side historical data (TwelveData) and secure Bridge + EA for production.');
</script>
</body>
</html>
