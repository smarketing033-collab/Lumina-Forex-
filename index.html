<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lumina AI ‚Äî Ultra MAXX (Front-end POC)</title>
<meta name="description" content="Lumina AI ‚Äî TradingView charts, 160+ forex pairs, multi-mode (auto/manual), assistant, demo/real toggle, bridge-ready." />
<!-- TradingView official widget -->
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
  :root{
    --bg-dark: #071023;
    --panel-dark: #071428;
    --muted: #9fb0c8;
    --accent: #ff6fa3; /* pink/love accent */
    --accent2: #7c5cff;
    --success: #39d353;
    --danger: #ff4d4f;
    --glass: rgba(255,255,255,0.03);
    --card: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg-dark);color:#e6f0fb}
  .app{max-width:1180px;margin:0 auto;padding:10px}
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:8px;border-radius:10px;background:linear-gradient(90deg,#021021, #03182a)}
  select,input,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  #chart-wrap{height:46vh;margin:12px 0;border-radius:10px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .panel{padding:12px;border-radius:12px;background:var(--card);margin-bottom:14px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  #indicatorSelect{width:320px}
  #luminaBtn{position:fixed;right:18px;bottom:18px;width:64px;height:64px;border-radius:16px;background:linear-gradient(90deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;border:none;z-index:1200;box-shadow:0 12px 30px rgba(124,92,255,0.16)}
  #assistantSlide{position:fixed;right:0;top:0;height:100%;width:420px;max-width:95%;background:var(--panel-dark);box-shadow:-20px 0 60px rgba(0,0,0,0.6);transform:translateX(100%);transition:transform .28s ease-in-out;z-index:1199;padding:12px;overflow:auto}
  #assistantSlide.open{transform:translateX(0)}
  .small{font-size:13px;color:var(--muted)}
  .signal{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
  .pair-list{max-height:240px;overflow:auto}
  .history{max-height:140px;overflow:auto;font-family:monospace;font-size:12px;color:var(--muted)}
  .onchart-label{position:absolute;z-index:1100;padding:6px 8px;border-radius:8px;font-weight:700;color:#fff;pointer-events:none;box-shadow:0 8px 20px rgba(0,0,0,0.6)}
  .buy-label{background:var(--success)}
  .sell-label{background:var(--danger)}
  .theme-light body, .theme-light .app{background:#fff;color:#0b1220}
  .theme-light .panel{background:linear-gradient(180deg,rgba(0,0,0,0.02),rgba(0,0,0,0.00))}
  .flex{display:flex;gap:8px;align-items:center}
  footer.note{color:var(--muted);font-size:13px;padding:12px;text-align:center}
  @media(max-width:900px){ #assistantSlide{width:100%} #chart-wrap{height:38vh} .app{padding:6px} }
</style>
</head>
<body>
<div class="app" id="appRoot">

  <!-- TOP BAR -->
  <div class="topbar">
    <div style="min-width:200px">
      <div class="small">Mode: <strong id="modeLabel">DEMO</strong></div>
      <div class="small">Balance: <strong id="balanceVal">$50,000.00</strong></div>
    </div>

    <div style="flex:1;display:flex;gap:8px;align-items:center;justify-content:center">
      <input id="pairSearch" placeholder="Search pairs (EURUSD,GBPUSD...)" style="min-width:220px"/>
      <select id="pairSelect"></select>
      <select id="timeframeSelect">
        <option value="1">1s</option><option value="60" selected>1m</option><option value="300">5m</option><option value="900">15m</option>
        <option value="3600">1H</option><option value="14400">4H</option><option value="86400">1D</option>
      </select>
      <select id="tzSelect" title="Timezone" style="min-width:140px"></select>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <input id="bridgeUrl" placeholder="Bridge URL (https://...)" style="width:200px"/>
      <input id="bridgeUser" placeholder="user" style="width:90px"/>
      <input id="bridgePass" placeholder="pass" type="password" style="width:100px"/>
      <button id="connectBtn" class="btn">Connect Bridge</button>
      <button id="themeBtn" class="btn">Theme</button>
      <button id="accountToggle" class="btn">DEMO / REAL</button>
    </div>
  </div>

  <!-- Chart -->
  <div id="chart-wrap">
    <div id="tv_chart_container" style="height:100%;"></div>
    <!-- DOM on-chart markers will be appended here -->
  </div>

  <!-- Trade Controls -->
  <div class="panel controls">
    <div class="flex">
      <button id="buyBtn" class="btn" style="background:var(--success);color:#001">BUY</button>
      <button id="sellBtn" class="btn" style="background:var(--danger);color:#fff">SELL</button>
      <input id="lotInput" placeholder="Lot e.g. 0.01" style="width:110px" value="0.01"/>
      <div class="small">SL<input id="sl" placeholder="SL (price)" style="width:110px"/></div>
      <div class="small">TP<input id="tp" placeholder="TP (price)" style="width:110px"/></div>
      <button id="exitAllBtn" class="btn" style="background:#ac8c2b">EXIT ALL</button>
    </div>

    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <label class="small">Mode</label>
      <select id="modeSelect"><option value="auto">AUTO</option><option value="manual">MANUAL</option></select>
      <label class="small">ManualMin</label><input id="manualMin" type="number" value="95" style="width:72px"/>
      <label class="small">AutoMin</label><input id="autoMin" type="number" value="100" style="width:72px"/>
      <select id="indicatorSelect" title="Indicators (visible)">
        <option>Loading indicators...</option>
      </select>
    </div>
  </div>

  <!-- Live Signals & History -->
  <div class="panel" style="display:flex;gap:16px">
    <div style="flex:1">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Live Signals</strong>
        <div class="small"><button id="exportBtn" class="btn">Export</button> <button id="clearBtn" class="btn">Clear</button> <button id="toggleOnChartBtn" class="btn">Toggle On-Chart</button></div>
      </div>
      <div id="signalList" style="max-height:260px;overflow:auto;margin-top:8px"></div>
    </div>

    <div style="width:320px">
      <div class="small">History</div>
      <div id="history" class="history panel" style="background:transparent;padding:8px"></div>
      <div style="margin-top:8px">
        <div class="small">Quick Pairs</div>
        <div id="quickPairs" class="pair-list panel" style="background:transparent;padding:8px"></div>
      </div>
    </div>
  </div>

  <footer class="note">Lumina Ultra-MAXX ‚Äî front-end POC. For production: deploy secure Bridge & MT5 EA and server-side historical analysis (TwelveData etc.)</footer>
</div>

<!-- Assistant button and slide -->
<button id="luminaBtn" title="Open Lumina">üíó</button>
<div id="assistantSlide" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>Lumina ‚Äî Assistant</h3>
    <div>
      <select id="assistantVoice">
        <option value="girlfriend">Girlfriend (cute)</option>
        <option value="pro">Professional</option>
      </select>
      <select id="assistantLang">
        <option value="en-US">English (US)</option>
        <option value="ur-PK">Urdu (PK)</option>
      </select>
      <button id="closeAssistant" class="btn">Close</button>
    </div>
  </div>

  <div style="margin-top:8px">
    <input id="assistantInput" placeholder="Ask Lumina..." style="width:100%;padding:8px;border-radius:8px"/>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="assistantAsk" class="btn">Ask</button>
      <button id="assistantMic" class="btn">üé§</button>
      <label class="btn">üìÅ<input id="assistantFile" type="file" style="display:none"/></label>
      <button id="assistantCamera" class="btn">Camera</button>
      <button id="deleteChat" class="btn">Delete Chat</button>
    </div>

    <div id="assistantChat" style="margin-top:12px;max-height:64vh;overflow:auto;border-top:1px solid rgba(255,255,255,0.04);padding-top:8px"></div>
  </div>
</div>

<script>
/* ============================
   Configuration / constants
   ============================ */
const AUTO_SCAN_INTERVAL_MS = 1000; // 1 second as requested (A). Change if too aggressive.
const SAVE_BRIDGE_CREDS = true;     // A: Save login info in browser (localStorage)
const VISIBLE_INDICATORS = true;    // visible indicators selected (A)
const INITIAL_DEMO_BALANCE = 50000.00;

/* ============================
   DOM shortcuts
   ============================ */
const pairSelect = document.getElementById('pairSelect');
const pairSearch = document.getElementById('pairSearch');
const tzSelect = document.getElementById('tzSelect');
const timeframeSelect = document.getElementById('timeframeSelect');
const indicatorSelect = document.getElementById('indicatorSelect');
const signalList = document.getElementById('signalList');
const historyBox = document.getElementById('history');
const quickPairsBox = document.getElementById('quickPairs');
const modeSelect = document.getElementById('modeSelect');
const balanceValEl = document.getElementById('balanceVal');
const modeLabel = document.getElementById('modeLabel');
const bridgeUrlEl = document.getElementById('bridgeUrl');
const bridgeUserEl = document.getElementById('bridgeUser');
const bridgePassEl = document.getElementById('bridgePass');
const connectBtn = document.getElementById('connectBtn');
const luminaBtn = document.getElementById('luminaBtn');
const assistantSlide = document.getElementById('assistantSlide');

let DEMO_MODE = true;
let demoBalance = INITIAL_DEMO_BALANCE;
let tradeHistory = [];
let signals = [];
let showOnChart = true;
let tvWidget = null;
let onChartMarkers = [];

/* ============================
   Time zones & pairs init
   ============================ */
const timezoneMap = {
  "America/New_York":"New York",
  "Europe/London":"London",
  "Asia/Tokyo":"Tokyo",
  "Asia/Kolkata":"India",
  "Australia/Sydney":"Sydney",
  "America/Chicago":"Chicago",
  "America/Los_Angeles":"Los Angeles",
  "America/Sao_Paulo":"Sao Paulo",
  "Asia/Dubai":"Dubai",
  "Asia/Singapore":"Singapore",
  "Asia/Shanghai":"Shanghai",
  "Asia/Ho_Chi_Minh":"Ho Chi Minh",
  "Europe/Berlin":"Berlin",
  "Europe/Moscow":"Moscow",
  "Etc/UTC":"UTC",
};
Object.keys(timezoneMap).forEach(t=>{
  const o = document.createElement('option'); o.value = t; o.textContent = timezoneMap[t] + ' ('+t+')'; tzSelect.appendChild(o);
});

/* Build a large list (160+) of forex pairs */
const baseCurrencies = ['EUR','USD','GBP','JPY','AUD','NZD','CAD','CHF','SGD','HKD','CNY','MXN','ZAR','SEK','NOK','TRY','BRL','INR','KRW','PLN','RUB'];
let pairs = [];
baseCurrencies.forEach(a=>{
  baseCurrencies.forEach(b=>{
    if(a===b) return;
    pairs.push(a+b);
  });
});
pairs = Array.from(new Set(pairs)).slice(0,160);

/* populate pairSelect */
pairs.forEach(p=>{
  let tz = 'Etc/UTC';
  if(p.includes('USD')) tz = 'America/New_York';
  else if(p.includes('EUR')) tz = 'Europe/London';
  else if(p.includes('JPY')) tz = 'Asia/Tokyo';
  else if(p.includes('AUD')||p.includes('NZD')) tz = 'Australia/Sydney';
  const opt = document.createElement('option'); opt.value = p; opt.textContent = p.slice(0,3)+'/'+p.slice(3)+' - '+timezoneMap[tz]+' ('+tz+')'; opt.dataset.tz = tz; pairSelect.appendChild(opt);
});

/* Quick pairs UI */
['EURUSD','GBPUSD','USDJPY','AUDUSD','USDCHF','USDCAD','BTCUSD','XAUUSD'].forEach(p=>{
  const btn = document.createElement('div'); btn.className='btn'; btn.style.display='block'; btn.style.marginBottom='6px'; btn.textContent = p;
  btn.addEventListener('click', ()=>{ selectPair(p); });
  quickPairsBox.appendChild(btn);
});

/* search filter */
pairSearch.addEventListener('input', e=>{
  const q = e.target.value.trim().toUpperCase();
  pairSelect.innerHTML = '';
  pairs.filter(p=>p.includes(q)).forEach(p=>{
    const tz = p.includes('USD') ? 'America/New_York' : (p.includes('JPY') ? 'Asia/Tokyo' : 'Europe/London');
    const o = document.createElement('option'); o.value=p; o.dataset.tz = tz; o.textContent = p.slice(0,3)+'/'+p.slice(3)+' - '+timezoneMap[tz]+' ('+tz+')';
    pairSelect.appendChild(o);
  });
});

/* ============================
   Indicators list (500+) populate
   ============================ */
const commonIndicators = ["RSI","MACD","Stochastic","Bollinger Bands","EMA","SMA","VWAP","ATR","ADX","CCI","OBV","Ichimoku","Parabolic SAR","Volume Profile","SuperTrend"];
indicatorSelect.innerHTML = '';
commonIndicators.forEach(i=>{ const o=document.createElement('option'); o.value=i; o.textContent=i; indicatorSelect.appendChild(o); });
for(let k=1;k<=520;k++){ const name='Custom '+k; const o=document.createElement('option'); o.value=name; o.textContent=name; indicatorSelect.appendChild(o); }

/* ============================
   TradingView widget wrapper
   ============================ */
function createTV(symbol='EURUSD', interval='60', timezone='Etc/UTC'){
  try{ if(tvWidget && tvWidget.remove) tvWidget.remove(); }catch(e){}
  const tvSymbol = (symbol.length===6) ? 'FX:'+symbol.replace('/','') : symbol;
  const opts = {
    symbol: tvSymbol,
    interval: mapIntervalToTV(interval),
    container_id: "tv_chart_container",
    library_path: "https://s3.tradingview.com/",
    locale: "en",
    theme: "dark",
    autosize: true,
    disabled_features: ["use_localstorage_for_settings"],
    enabled_features: ["study_templates"],
    overrides: {
      "mainSeriesProperties.candleStyle.upColor": "#39d353",
      "mainSeriesProperties.candleStyle.downColor": "#ff4d4f",
      "paneProperties.background": "#071023"
    }
  };
  try{ tvWidget = new TradingView.widget(opts); }catch(e){ console.warn('tv create fail', e); }
}
function mapIntervalToTV(sec){
  const map = { '1':"1",'60':"1",'300':"5",'900':"15",'3600':"60",'14400':"240",'86400':"D" };
  return map[sec] || (sec/60).toString();
}

/* initialize default */
createTV(pairSelect.value || 'EURUSD', timeframeSelect.value, tzSelect.value);

/* refresh on change */
pairSelect.addEventListener('change', ()=>{ createTV(pairSelect.value, timeframeSelect.value, pairSelect.selectedOptions[0].dataset.tz || tzSelect.value); });
timeframeSelect.addEventListener('change', ()=>{ createTV(pairSelect.value, timeframeSelect.value, pairSelect.selectedOptions[0].dataset.tz || tzSelect.value); });

/* ============================
   Bridge credentials (save in localStorage if chosen)
   ============================ */
function loadSavedBridge(){
  if(!SAVE_BRIDGE_CREDS) return;
  const u = localStorage.getItem('lumina_bridge_user') || '';
  const p = localStorage.getItem('lumina_bridge_pass') || '';
  const url = localStorage.getItem('lumina_bridge_url') || '';
  bridgeUserEl.value = u; bridgePassEl.value = p; bridgeUrlEl.value = url;
}
function saveBridge(){
  if(!SAVE_BRIDGE_CREDS) return;
  localStorage.setItem('lumina_bridge_user', bridgeUserEl.value || '');
  localStorage.setItem('lumina_bridge_pass', bridgePassEl.value || '');
  localStorage.setItem('lumina_bridge_url', bridgeUrlEl.value || '');
}
connectBtn.addEventListener('click', ()=>{
  saveBridge();
  alert('Bridge saved locally. Keep server secrets on server only.');
});
loadSavedBridge();

/* ============================
   Demo account handling
   ============================ */
function setDemoMode(enabled){
  DEMO_MODE = enabled;
  modeLabel.textContent = enabled ? 'DEMO' : 'REAL';
  document.getElementById('accountToggle').textContent = enabled ? 'DEMO' : 'REAL';
  updateBalanceDisplay();
  // Persist selection
  localStorage.setItem('lumina_demo_mode', enabled ? '1' : '0');
}
function updateBalanceDisplay(){
  balanceValEl.textContent = (DEMO_MODE ? '$' + demoBalance.toFixed(2) : '‚Äî (real)');
}
document.getElementById('accountToggle').addEventListener('click', ()=>{
  setDemoMode(!DEMO_MODE);
});
const savedDemo = localStorage.getItem('lumina_demo_mode');
if(savedDemo !== null) setDemoMode(savedDemo==='1'); else setDemoMode(true);

/* ============================
   Signals / POC Analyzer (front-end)
   NOTES:
   - This is a POC/demo analyzer. Replace with server-side SMC+historical engine for production.
   - We simulate analysis then apply thresholds; for real accuracy you must plug a model.
   ============================ */
function addSignal(s){
  signals.unshift(s);
  if(signals.length>200) signals.pop();
  renderSignals();
  if(s.executed && DEMO_MODE){
    // update demo balance (very simple PnL sim): when trade closes we update by (tp - entry) * leverage/lot etc. Simplified:
    // We'll update when trade is "closed" ‚Äî for demo we treat executed trades as immediate PnL zero unless we close via EXIT or similar.
  }
}
function renderSignals(){
  signalList.innerHTML = '';
  signals.forEach((s, idx)=>{
    const el = document.createElement('div'); el.className='signal';
    const left = document.createElement('div');
    left.innerHTML = `<strong style="color:${s.type==='buy' ? 'var(--success)' : 'var(--danger)'}">${s.type.toUpperCase()}</strong>
                      <div class="small">${s.pair} ‚Ä¢ ${s.tf}s ‚Ä¢ ${new Date(s.time).toLocaleTimeString()}</div>
                      <div class="small">Entry: ${s.entry} ‚Ä¢ SL: ${s.sl} ‚Ä¢ TP: ${s.tp}</div>`;
    const right = document.createElement('div'); right.style.textAlign='right';
    right.innerHTML = `<div style="font-weight:700">${s.confidence}%</div>
                       <div style="margin-top:6px"><button class="btn" onclick="confirmManual(${idx})">Confirm</button> <button class="btn" onclick="removeSignal(${idx})">Remove</button></div>`;
    el.appendChild(left); el.appendChild(right);
    signalList.appendChild(el);
  });
}

/* Remove & confirm handlers (used by buttons above) */
window.removeSignal = function(i){
  signals.splice(i,1);
  renderSignals();
};
window.confirmManual = function(i){
  // Manual confirm -> send to bridge or simulate
  const s = signals[i];
  if(!s) return alert('Signal missing');
  // If mode is manual and confidence >= manualMin then allow confirm
  const conf = s.confidence || 0;
  const manualMin = parseInt(document.getElementById('manualMin').value || '95');
  if(modeSelect.value!=='manual') return alert('Switch to MANUAL mode to confirm trades.');
  if(conf < manualMin) return alert('Confidence lower than ManualMin.');
  placeTrade({ manual:true, cmd: s.type, symbol:s.pair, volume: parseFloat(document.getElementById('lotInput').value)||0.01, sl: s.sl, tp: s.tp });
  // optionally mark executed in UI
  signals[i].executed = true;
  renderSignals();
};

/* ============================
   Simulated analyzer loop (runs every AUTO_SCAN_INTERVAL_MS)
   - NOTE: this is a front-end demonstration only. Replace with robust server-side analysis for production.
   ============================ */
function makeFakeAnalysis(){
  // pick current pair and timeframe
  const pair = pairSelect.value || 'EURUSD';
  const tf = timeframeSelect.value;
  // fake price and levels: using random around 1.00 to give variety
  const price = (1.0 + (Math.random()-0.5)*0.02).toFixed(5);
  const entry = parseFloat(price);
  const sl = (entry - (Math.random()*0.001)).toFixed(5);
  const tp = (entry + (Math.random()*0.002)).toFixed(5);
  // confidence: for demo we push high numbers occasionally
  const conf = Math.min(130, Math.round(80 + Math.random()*50)); // 80..130
  const type = Math.random()>0.5 ? 'buy' : 'sell';
  return { pair, tf, time:Date.now(), entry: entry.toFixed(5), sl, tp, confidence: conf, type };
}

function analyzerTick(){
  const s = makeFakeAnalysis();
  // Manual: only show signals if conf >= manualMin; Auto: execute if >= autoMin
  const manualMin = parseInt(document.getElementById('manualMin').value || '95');
  const autoMin = parseInt(document.getElementById('autoMin').value || '100');

  if(modeSelect.value === 'manual'){
    if(s.confidence >= manualMin){
      addSignal({ pair: s.pair, tf: s.tf, time: s.time, entry: s.entry, sl: s.sl, tp: s.tp, confidence: s.confidence, type: s.type });
      appendHistory(`${new Date().toLocaleString()} ‚Ä¢ ${s.pair} ‚Ä¢ ${s.type.toUpperCase()} ‚Ä¢ ${s.entry} ‚Ä¢ CONF ${s.confidence}%`);
    }
  } else {
    // AUTO mode: only execute if >= autoMin
    if(s.confidence >= autoMin){
      // placeTrade will call bridge or simulate update demo balance
      placeTrade({ ea_id:'lumina_ea_01', cmd: s.type, symbol: s.pair, volume: parseFloat(document.getElementById('lotInput').value)||0.01, sl: s.sl, tp: s.tp, time:Date.now(), confidence: s.confidence });
      addSignal({ pair: s.pair, tf: s.tf, time: s.time, entry: s.entry, sl: s.sl, tp: s.tp, confidence: s.confidence, type: s.type, executed:true });
      appendHistory(`${new Date().toLocaleString()} ‚Ä¢ ${s.pair} ‚Ä¢ ${s.type.toUpperCase()} ‚Ä¢ ${s.entry} ‚Ä¢ AUTO-EXEC ${s.confidence}%`);
    }
  }
}

/* start analyzer loop */
setInterval(analyzerTick, AUTO_SCAN_INTERVAL_MS);

/* ============================
   Place trade: send to bridge or simulate demo
   Bridge endpoint expected:
     POST { ...body... } -> JSON {ok:true, id:..., msg:...}
   ============================ */
async function placeTrade(body){
  const bridgeUrl = bridgeUrlEl.value.trim() || localStorage.getItem('lumina_bridge_url') || '';
  const user = bridgeUserEl.value.trim() || localStorage.getItem('lumina_bridge_user') || '';
  const pass = bridgePassEl.value.trim() || localStorage.getItem('lumina_bridge_pass') || '';
  // If SAVE_BRIDGE_CREDS true persist
  if(SAVE_BRIDGE_CREDS){ localStorage.setItem('lumina_bridge_user', user); localStorage.setItem('lumina_bridge_pass', pass); localStorage.setItem('lumina_bridge_url', bridgeUrl); }

  // Demo simulation: immediate "open" and small random PnL after
  if(DEMO_MODE || !bridgeUrl){
    // Simulate opening a trade and random outcome in a few seconds
    const id = 'demo-'+Date.now();
    tradeHistory.unshift({ id, ...body, time:Date.now(), pnl:0, status:'open' });
    appendHistory(`${new Date().toLocaleString()} ‚Ä¢ ${body.symbol} ‚Ä¢ ${body.cmd.toUpperCase()} ‚Ä¢ open`);
    updateHistoryUI();
    // Simulate result after 3-6s
    setTimeout(()=>{
      const pnl = parseFloat(((Math.random()-0.45) * 5 * (body.volume || 0.01)).toFixed(2)); // small random
      tradeHistory[0].pnl = pnl;
      tradeHistory[0].status = pnl >= 0 ? 'win' : 'loss';
      appendHistory(`${new Date().toLocaleString()} ‚Ä¢ ${body.symbol} ‚Ä¢ ${body.cmd.toUpperCase()} ‚Ä¢ ${tradeHistory[0].status} ‚Ä¢ pnl ${pnl.toFixed(2)}`);
      // update demoBalance
      demoBalance += pnl;
      updateBalanceDisplay();
      updateHistoryUI();
    }, 3000 + Math.random()*3000);
    return { ok:true, id };
  }

  // Real bridge call
  try{
    const res = await fetch(bridgeUrl + '/api/trade', {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'Authorization': 'Basic ' + btoa(user + ':' + pass)
      },
      body: JSON.stringify(body)
    });
    const j = await res.json();
    appendHistory(`${new Date().toLocaleString()} ‚Ä¢ ${body.symbol} ‚Ä¢ ${body.cmd.toUpperCase()} ‚Ä¢ bridge:${j.ok ? 'queued' : 'err'}`);
    return j;
  }catch(e){
    appendHistory(`[bridge error] ${e.message}`);
    return { ok:false, error:e.message };
  }
}

/* ============================
   Update UI helpers: history & signal
   ============================ */
function appendHistory(text){
  const now = new Date();
  const line = `${text}`;
  const p = document.createElement('div'); p.textContent = line;
  historyBox.prepend(p);
}
function updateHistoryUI(){
  historyBox.innerHTML = '';
  tradeHistory.slice(0,40).forEach(t=>{
    const d = document.createElement('div');
    d.textContent = `${new Date(t.time).toLocaleString()} ‚Ä¢ ${t.symbol} ‚Ä¢ ${t.cmd.toUpperCase()} ‚Ä¢ ${t.status || 'open'} ‚Ä¢ pnl ${t.pnl || 0}`;
    historyBox.appendChild(d);
  });
}

/* ============================
   On-chart labels rendering (simple DOM overlay, not candle-anchored)
   - For real anchored labels use TradingView Charting Library with API (not casual widget).
   ============================ */
function clearOnChartMarkers(){
  onChartMarkers.forEach(m=>m.remove());
  onChartMarkers = [];
}
function showOnChartLabel(x,y, text, cls){
  const lab = document.createElement('div');
  lab.className = `onchart-label ${cls}`;
  lab.style.left = (x)+'px';
  lab.style.top = (y)+'px';
  lab.textContent = text;
  document.getElementById('tv_chart_container').appendChild(lab);
  onChartMarkers.push(lab);
  // auto-fade/remove after 10s
  setTimeout(()=>{ lab.remove(); }, 10000);
}

/* Toggle on-chart labels */
document.getElementById('toggleOnChartBtn').addEventListener('click', ()=>{
  showOnChart = !showOnChart;
  alert('On-chart labels ' + (showOnChart ? 'enabled' : 'disabled'));
});

/* ============================
   Buy / Sell / Exit handlers
   ============================ */
document.getElementById('buyBtn').addEventListener('click', ()=>manualPlace('buy'));
document.getElementById('sellBtn').addEventListener('click', ()=>manualPlace('sell'));
document.getElementById('exitAllBtn').addEventListener('click', ()=>{ tradeHistory.forEach(t=>t.status='closed'); appendHistory('EXIT ALL triggered'); updateHistoryUI(); });

async function manualPlace(side){
  if(modeSelect.value !== 'manual') { alert('Switch to MANUAL mode for manual trades.'); return; }
  const body = { ea_id:'lumina_ea_01', cmd: side, symbol: pairSelect.value, volume: parseFloat(document.getElementById('lotInput').value)||0.01, sl: document.getElementById('sl').value || 0, tp: document.getElementById('tp').value || 0, manual:true, time: Date.now() };
  const r = await placeTrade(body);
  if(r.ok) alert('Manual trade queued (demo/bridge).');
}

/* ============================
   Theme toggle (dark/light)
   ============================ */
let isLight = false;
document.getElementById('themeBtn').addEventListener('click', ()=>{
  isLight = !isLight;
  document.documentElement.classList.toggle('theme-light', isLight);
});

/* ============================
   Assistant behavior (slide)
   ============================ */
luminaBtn.addEventListener('click', ()=>assistantSlide.classList.toggle('open'));
document.getElementById('closeAssistant').addEventListener('click', ()=>assistantSlide.classList.remove('open'));
document.getElementById('assistantAsk').addEventListener('click', assistantAsk);
document.getElementById('deleteChat').addEventListener('click', ()=>{ document.getElementById('assistantChat').innerHTML=''; });

/* simple assistant reply POC using local logic (replace with model calls server-side for advanced behavior) */
function assistantAsk(){
  const q = document.getElementById('assistantInput').value.trim();
  if(!q) return;
  appendAssistant('You', q);
  // POC: quick local reply
  setTimeout(()=>{
    const voiceMode = document.getElementById('assistantVoice').value;
    let reply = '';
    if(q.toLowerCase().includes('hi') || q.toLowerCase().includes('hello')) reply = (voiceMode==='girlfriend' ? 'Hi baby üíï ‚Äî want me to scan the current chart?' : 'Hello ‚Äî ready to analyze the chart.');
    else if(q.toLowerCase().includes('analyze')) reply = 'Lumina: performing quick scan (POC). I check trend, RSI, EMA, volume spikes, and order blocks.';
    else reply = 'Lumina: I saw that. For deeper analysis I recommend switching to server-side analysis (bridge) for full history + SMC.';
    appendAssistant('Lumina', reply);
    // speak
    speakText(reply, document.getElementById('assistantLang').value);
  },700);
}
function appendAssistant(who, text){
  const box = document.getElementById('assistantChat');
  const el = document.createElement('div');
  el.innerHTML = `<strong>${who}:</strong> <div class="small">${text}</div>`;
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}

/* speech synthesis */
function speakText(text, lang='en-US'){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.pitch = (document.getElementById('assistantVoice').value==='girlfriend') ? 1.1 : 1.0;
    u.rate = 1;
    const voices = speechSynthesis.getVoices();
    // pick a female if present
    const female = voices.find(v => /female|zira|sara|joanna/i.test(v.name) || v.lang.startsWith('en'));
    if(female) u.voice = female;
    speechSynthesis.speak(u);
  }catch(e){ console.warn('TTS fail', e); }
}

/* optional: assistant mic (speech-to-text) - depends on browser support */
let recognition = null;
document.getElementById('assistantMic').addEventListener('click', async ()=>{
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){ alert('SpeechRecognition not supported'); return; }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = document.getElementById('assistantLang').value || 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.start();
  recognition.onresult = (e)=>{ const text = e.results[0][0].transcript; document.getElementById('assistantInput').value = text; assistantAsk(); };
  recognition.onerror = (e)=>{ console.warn('recog err',e); alert('Speech error'); };
});

/* ============================
   Utilities
   ============================ */
function selectPair(p){
  const opts = Array.from(pairSelect.options);
  const found = opts.find(o=>o.value===p);
  if(found){ pairSelect.value = p; pairSelect.dispatchEvent(new Event('change')); }
}

/* ============================
   On-load: set UI initial state
   ============================ */
updateBalanceDisplay();
appendHistory('Lumina Ultra-MAXX loaded (POC). For true 100% signals integrate server analysis and MT5 EA.');
renderSignals();
updateHistoryUI();

/* Expose some helper functions to window for debugging */
window.Lumina = {
  placeTrade, addSignal, clearOnChartMarkers, showOnChartLabel, selectPair
};

</script>
</body>
</html>
