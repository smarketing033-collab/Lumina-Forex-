<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lumina AI â€” Ultra Maxx (Fixed)</title>
<meta name="description" content="Lumina AI POC â€” auto analysis, assistant, demo/real persistence, manual confirm, lot +/- buttons, many pairs" />
<!-- TradingView widget -->
<script src="https://s3.tradingview.com/tv.js"></script>
<style>
  :root{
    --bg:#071023;--panel:#071428;--muted:#9fb0c8;--accent:#39d353;--danger:#ff4d4f;--card:#0b1a2a;--glass:rgba(255,255,255,0.02);
  }
  [data-theme="light"]{
    --bg:#f5f7fb;--panel:#ffffff;--muted:#334155;--accent:#0f9d58;--danger:#c62828;--card:#ffffff;--glass:rgba(2,6,23,0.02);color:#071428;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#e6f0fb;min-height:100vh}
  .wrap{max-width:1200px;margin:6px auto;padding:8px}
  .topbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .left{display:flex;gap:8px;align-items:center;flex:1}
  .card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0));padding:10px;border-radius:10px}
  input,select,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  .btn{cursor:pointer}
  #chartRow{display:grid;grid-template-columns: 1fr 360px; gap:12px;margin-top:12px}
  @media(max-width:980px){ #chartRow{grid-template-columns:1fr} .right-col{order:2} .tvCard{height:46vh} }
  #tvContainer{height:68vh;border-radius:10px;overflow:hidden;background:var(--card)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:12px;color:var(--muted)}
  .signal{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
  .pairList{display:flex;flex-direction:column;gap:6px;max-height:240px;overflow:auto}
  .pairBtn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;text-align:left}
  .history{max-height:200px;overflow:auto;font-size:13px;color:var(--muted)}
  #luminaBtn{position:fixed;right:18px;bottom:18px;width:62px;height:62px;border-radius:16px;background:linear-gradient(90deg,#ff758c,#7c5cff);display:flex;align-items:center;justify-content:center;color:#fff;border:none;z-index:1200}
  #luminaPanel{position:fixed;right:0;top:0;height:100%;width:420px;max-width:95%;background:var(--panel);transform:translateX(110%);transition:transform .28s ease-in-out;z-index:1199;padding:12px;overflow:auto}
  #luminaPanel.open{transform:translateX(0)}
  .bubble.you{background:rgba(255,255,255,0.04);align-self:flex-end;padding:10px;border-radius:10px;max-width:85%}
  .bubble.lumina{background:linear-gradient(90deg,#7c5cff,#ff758c);color:#fff;align-self:flex-start;padding:10px;border-radius:10px;max-width:85%}
  .mutedSmall{font-size:12px;color:var(--muted)}
  .lotControl{display:flex;gap:6px;align-items:center}
</style>
</head>
<body data-theme="dark">
<div class="wrap">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="left card" style="align-items:center">
      <div style="margin-right:8px">
        <div class="mutedSmall">Account</div>
        <div id="modeBadge" style="font-weight:800">DEMO</div>
      </div>

      <div style="margin-right:8px">
        <div class="mutedSmall">Balance</div>
        <div id="balanceVal" style="font-weight:700">$50,000.00</div>
      </div>

      <div style="margin-right:8px">
        <div class="mutedSmall">Lot</div>
        <div class="lotControl">
          <button id="lotDec" class="btn">âˆ’</button>
          <input id="lotVal" value="0.01" style="width:80px;text-align:center"/>
          <button id="lotInc" class="btn">+</button>
        </div>
      </div>

      <div style="flex:1">
        <input id="pairSearch" placeholder="Search pairs (EURUSD,BTCUSD...)" style="width:100%"/>
      </div>

      <select id="pairSelect" style="min-width:140px"></select>
      <select id="timeframe" style="width:96px">
        <option value="60">1m</option><option value="300">5m</option><option value="900">15m</option><option value="3600">1h</option><option value="14400">4h</option><option value="86400">1d</option><option value="604800">1w</option><option value="2592000">1M</option><option value="31536000">1Y</option>
      </select>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <input id="bridgeUrl" placeholder="Bridge URL (https://...)" style="width:300px"/>
      <input id="bridgeUser" placeholder="user" style="width:90px"/>
      <input id="bridgePass" placeholder="pass" type="password" style="width:110px"/>
      <button id="connectBridge" class="btn card">Connect Bridge</button>
      <button id="themeToggle" class="btn card">Theme</button>
      <!-- Demo/Real is only here now -->
      <button id="switchDemo" class="btn card">DEMO</button>
      <button id="switchReal" class="btn card">REAL</button>
    </div>
  </div>

  <!-- CHART & RIGHT COL -->
  <div id="chartRow">
    <div>
      <div id="tvContainer" class="card tvCard">
        <div id="tv_chart_container" style="width:100%;height:100%"></div>
      </div>

      <!-- Controls row -->
      <div class="card controls" style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="buyBtn" class="btn" style="background:#072a18;color:var(--accent)">BUY</button>
          <button id="sellBtn" class="btn" style="background:#2a0b0b;color:var(--danger)">SELL</button>
          <input id="sl" placeholder="SL (price)" style="width:120px"/>
          <input id="tp" placeholder="TP (price)" style="width:120px"/>
          <button id="exitAll" class="btn" style="background:#5a3c00;color:#fff">EXIT ALL</button>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <label class="mutedSmall">Mode</label>
            <select id="modeSelect"><option value="auto">AUTO</option><option value="manual">MANUAL</option></select>
            <label class="mutedSmall">ManualMin</label><input id="manualMin" type="number" value="95" style="width:70px"/>
            <label class="mutedSmall">AutoMin</label><input id="autoMin" type="number" value="100" style="width:70px"/>
            <label class="mutedSmall">Allow Auto Exec</label><input id="allowAuto" type="checkbox"/>
            <!-- Analyze removed â€” auto-analysis will run in background -->
          </div>
        </div>
      </div>

      <!-- Signals + history -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Live Signals</strong>
          <div style="display:flex;gap:8px">
            <button id="exportSignals" class="btn">Export</button>
            <button id="clearSignals" class="btn">Clear</button>
            <button id="toggleMarkers" class="btn">Toggle On-Chart</button>
          </div>
        </div>

        <div id="signalList" style="margin-top:10px;max-height:260px;overflow:auto"></div>

        <div style="margin-top:10px" class="history">
          <strong class="mutedSmall">History</strong>
          <div id="historyLog"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT COL -->
    <div class="right-col">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Quick Pairs</strong>
          <div style="display:flex;gap:8px">
            <input id="addPairInput" placeholder="Add pair (EURUSD)" style="width:120px"/>
            <button id="addPairBtn" class="btn">Add</button>
          </div>
        </div>
        <div class="pairList" id="pairsQuick" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Indicators (POC)</strong>
        <div class="mutedSmall">Add indicator names (POC). To fully apply TradingView studies you need Charting Library license.</div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="addIndName" placeholder="RSI, MACD..." style="flex:1"/>
          <button id="addIndBtn" class="btn">Add</button>
        </div>
        <div id="indList" style="margin-top:8px;max-height:160px;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<!-- Lumina assistant button & panel -->
<button id="luminaBtn" title="Lumina">â™¡</button>
<div id="luminaPanel" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3 style="margin:0">Lumina â€” Assistant</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <select id="voiceMode"><option value="girlfriend">Girlfriend</option><option value="professional">Pro</option></select>
      <select id="langSelect"><option value="en-US">English (US)</option><option value="en-GB">English (UK)</option><option value="es-ES">Spanish</option></select>
      <label class="mutedSmall"><input id="speakOn" type="checkbox"/> Speak</label>
      <button id="luminaClose" class="btn">Close</button>
    </div>
  </div>

  <div style="margin-top:10px">
    <div style="display:flex;gap:8px">
      <input id="luminaInput" placeholder="Ask Lumina..." style="flex:1"/>
      <button id="luminaSend" class="btn">Ask</button>
      <button id="luminaMic" class="btn">ðŸŽ¤</button>
    </div>

    <div id="luminaChat" style="margin-top:10px;max-height:72vh;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:8px;background:transparent"></div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="luminaFile" type="file" accept="image/*,.png,.jpg,.jpeg,.pdf"/>
      <button id="luminaCamera" class="btn">Camera</button>
      <button id="luminaClear" class="btn">Delete Chat</button>
    </div>
  </div>
</div>

<script>
/* -----------------------------
  Lumina AI Ultra Maxx â€” Front-end POC
  - Auto analysis runs in background every AUTO_ANALYSIS_INTERVAL_MS
  - Auto-exec only runs after analysis result exists for that pair and Allow Auto Exec checked
  - Demo/Real persist in localStorage
  - Manual trade requires CONFIRM in signal list
  - Lot +/- buttons and Add pair, Add indicator UI
  - Light mode fixed with proper color contrasts
  ----------------------------- */

const AUTO_ANALYSIS_INTERVAL_MS = 7000; // run analysis frequently (POC)
const DEMO_START_BAL = 50000;
let pairs = []; // will be filled
let signals = [];
let history = [];
let showMarkers = false;
let lastAnalysis = {}; // map pair->analysis

/* ---------- utils ---------- */
const $ = id => document.getElementById(id);
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k,def){ try{ const s=localStorage.getItem(k); return s?JSON.parse(s):def; }catch(e){return def;} }

/* ---------- persistence: account mode + lot + selected pair + mode ---------- */
const savedMode = load('lumina_account_mode','DEMO');
$('modeBadge').textContent = savedMode;
$('balanceVal').textContent = '$' + (load('lumina_balance', DEMO_START_BAL)).toFixed(2);
$('lotVal').value = load('lumina_lot', 0.01);
$('modeSelect').value = load('lumina_mode','auto');

/* ---------- pairs: load 160+ ---------- */
(function populatePairs(){
  const base = ["EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD","EURGBP","EURJPY","GBPJPY","XAUUSD","BTCUSD","ETHUSD"];
  const extras = ['CAD','CHF','AUD','NZD','JPY','GBP','EUR','USD','MXN','ZAR','SEK','NOK','TRY','BRL','INR','CNY','SGD','HKD','KRW','PLN','RUB'];
  let arr = [...base];
  for(let i=0;i<extras.length;i++){
    for(let j=0;j<extras.length;j++){
      if(i===j) continue;
      arr.push(extras[i]+extras[j]);
    }
  }
  arr = Array.from(new Set(arr)).slice(0,200);
  pairs = arr;
  // populate selects & quick list
  const ps = $('pairSelect'); ps.innerHTML='';
  arr.slice(0,160).forEach(p => {
    const o = document.createElement('option'); o.value=p; o.textContent=p.slice(0,3)+'/'+p.slice(3); ps.appendChild(o);
  });
  $('pairSelect').value = load('lumina_pair','EURUSD');

  const quick = $('pairsQuick'); quick.innerHTML='';
  arr.slice(0,30).forEach(p=>{
    const b = document.createElement('button'); b.className='pairBtn'; b.textContent = p.slice(0,3)+'/'+p.slice(3);
    b.addEventListener('click', ()=>{ $('pairSelect').value = p; createTV(p,$('timeframe').value); save('lumina_pair', p); });
    quick.appendChild(b);
  });
})();
$('pairSearch').addEventListener('input', e=>{
  const q = e.target.value.trim().toUpperCase();
  const ps = $('pairSelect'); ps.innerHTML='';
  pairs.filter(p => p.includes(q)).slice(0,160).forEach(p=>{
    const o = document.createElement('option'); o.value=p; o.textContent=p.slice(0,3)+'/'+p.slice(3); ps.appendChild(o);
  });
});

/* add-pair */
$('addPairBtn').addEventListener('click', ()=>{
  const p = $('addPairInput').value.trim().toUpperCase();
  if(!/^[A-Z]{6,7}$/.test(p)){ alert('Pair format like EURUSD'); return; }
  if(!pairs.includes(p)) pairs.unshift(p);
  save('lumina_pairs', pairs);
  populateAfterAdd(p);
  $('addPairInput').value=''; 
});
function populateAfterAdd(p){
  // refresh quick panel and select
  const quick = $('pairsQuick'); quick.innerHTML='';
  pairs.slice(0,30).forEach(pp=>{
    const b = document.createElement('button'); b.className='pairBtn'; b.textContent = pp.slice(0,3)+'/'+pp.slice(3);
    b.addEventListener('click', ()=>{ $('pairSelect').value = pp; createTV(pp,$('timeframe').value); save('lumina_pair', pp); });
    quick.appendChild(b);
  });
  // update select
  const ps = $('pairSelect'); ps.innerHTML=''; pairs.slice(0,160).forEach(pp=>{ const o=document.createElement('option'); o.value=pp; o.textContent=pp.slice(0,3)+'/'+pp.slice(3); ps.appendChild(o); });
  $('pairSelect').value = p;
  createTV(p, $('timeframe').value);
  save('lumina_pair', p);
}

/* ---------- indicators list (POC) ---------- */
$('addIndBtn').addEventListener('click', ()=>{
  const name = $('addIndName').value.trim();
  if(!name) return;
  const list = load('lumina_indicators', []);
  list.unshift(name);
  save('lumina_indicators', list);
  renderIndicators();
  $('addIndName').value='';
});
function renderIndicators(){
  const list = load('lumina_indicators', []);
  const out = $('indList'); out.innerHTML='';
  list.slice(0,50).forEach(i=>{
    const d = document.createElement('div'); d.textContent = i; d.style.padding='6px';
    out.appendChild(d);
  });
}
renderIndicators();

/* ---------- TV widget ---------- */
let tvWidget = null;
function mapInterval(tf){
  if(tf==='60') return '1'; if(tf==='300') return '5'; if(tf==='900') return '15'; if(tf==='3600') return '60';
  if(tf==='14400') return '240'; if(tf==='86400') return 'D'; if(tf==='604800') return 'W'; if(tf==='2592000') return 'M';
  return tf;
}
function createTV(symbol,tf){
  try{ if(tvWidget && tvWidget.remove) tvWidget.remove(); }catch(e){}
  const tvSymbol = (symbol && symbol.length===6) ? 'FX:'+symbol : symbol;
  const opts = {
    symbol: tvSymbol||'FX:EURUSD',
    container_id: "tv_chart_container",
    library_path: "https://s3.tradingview.com/",
    autosize: true,
    interval: mapInterval(tf),
    theme: (document.body.getAttribute('data-theme') === 'dark' ? 'Dark' : 'Light'),
    overrides: {
      "mainSeriesProperties.candleStyle.upColor": "#39d353",
      "mainSeriesProperties.candleStyle.downColor": "#ff4d4f"
    }
  };
  tvWidget = new TradingView.widget(opts);
}
createTV($('pairSelect').value, $('timeframe').value);
$('pairSelect').addEventListener('change', ()=>{ createTV($('pairSelect').value, $('timeframe').value); save('lumina_pair',$('pairSelect').value); });
$('timeframe').addEventListener('change', ()=>{ createTV($('pairSelect').value, $('timeframe').value); });

/* ---------- lot buttons ---------- */
$('lotInc').addEventListener('click', ()=>{ let v=parseFloat($('lotVal').value)||0.01; v = +(v + 0.01).toFixed(2); $('lotVal').value = v; save('lumina_lot', v); });
$('lotDec').addEventListener('click', ()=>{ let v=parseFloat($('lotVal').value)||0.01; v = Math.max(0.01, +(v - 0.01).toFixed(2)); $('lotVal').value = v; save('lumina_lot', v); });
$('lotVal').addEventListener('change', ()=>{ const v=parseFloat($('lotVal').value)||0.01; $('lotVal').value = v; save('lumina_lot', v); });

/* ---------- theme & account switches ---------- */
$('themeToggle').addEventListener('click', ()=>{
  const el = document.body; const t = el.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; el.setAttribute('data-theme', t); createTV($('pairSelect').value, $('timeframe').value);
});
$('switchDemo').addEventListener('click', ()=>{ $('modeBadge').textContent='DEMO'; save('lumina_account_mode','DEMO'); save('lumina_balance', DEMO_START_BAL); $('balanceVal').textContent = '$' + DEMO_START_BAL.toFixed(2); });
$('switchReal').addEventListener('click', ()=>{ $('modeBadge').textContent='REAL'; save('lumina_account_mode','REAL'); });

/* ---------- signals + manual confirm ---------- */
function renderSignals(){
  const el = $('signalList'); el.innerHTML='';
  signals.forEach(s=>{
    const div = document.createElement('div'); div.className='signal';
    div.innerHTML = `<div style="max-width:70%"><div style="display:flex;gap:8px;align-items:center"><strong style="color:${s.type==='buy'?'#39d353':'#ff4d4f'}">${s.type.toUpperCase()}</strong><div class="mutedSmall">${s.pair} â€¢ ${s.tf}s</div></div><div class="mutedSmall">Entry: ${s.price} â€¢ SL: ${s.sl} â€¢ TP: ${s.tp}</div></div><div style="text-align:right"><div style="font-weight:800">${s.confidence}%</div><div style="margin-top:8px">${$('modeSelect').value==='manual'?`<button class="btn" onclick="confirmManual('${s.id}')">CONFIRM</button>`:''}<button class="btn" onclick="removeSignal('${s.id}')">Remove</button></div></div>`;
    el.appendChild(div);
  });
}
function addSignal(s){
  s.id = 'sig_'+Date.now()+'_'+Math.floor(Math.random()*999);
  signals.unshift(s);
  if(signals.length>120) signals.pop();
  renderSignals();
  if(showMarkers) addMarkerOnChart(s);
  // Auto-exec safety: only when lastAnalysis exists and allowAuto checked
  if($('modeSelect').value==='auto' && $('allowAuto').checked){
    const pair = s.pair;
    if(lastAnalysis[pair] && (Date.now() - lastAnalysis[pair].time) < (AUTO_ANALYSIS_INTERVAL_MS*2)){
      if(s.confidence >= parseInt($('autoMin').value||100)){
        sendToBridge({...s, ea_id:'lumina_ea_01', cmd:s.type});
      } else {
        console.log('Auto suppressed by confidence', s.confidence);
      }
    } else {
      console.log('Auto suppressed: analysis missing for pair', pair);
    }
  }
}
window.removeSignal = function(id){ signals = signals.filter(x=>x.id!==id); renderSignals(); }
window.confirmManual = function(id){
  const s = signals.find(x=>x.id===id);
  if(!s) return alert('Signal not found');
  if(!confirm(`Confirm ${s.type.toUpperCase()} ${s.pair} @ ${s.price}?`)) return;
  sendToBridge({...s, manual:true, ea_id:'lumina_ea_01', cmd:s.type});
}

/* ---------- history render ---------- */
function renderHistory(){
  const el = $('historyLog'); el.innerHTML='';
  history.slice(0,120).forEach(h=>{
    const d = document.createElement('div'); d.className='mutedSmall';
    const when = new Date(h.time || h.closedAt).toLocaleString();
    d.textContent = `${when} Â· ${h.pair} Â· ${h.cmd} Â· ${h.status || ''} ${h.pnl ? ' Â· pnl '+h.pnl : ''}`;
    el.appendChild(d);
  });
}

/* ---------- simulate & send to bridge ---------- */
async function sendToBridge(body){
  const url = window.BRIDGE_URL || $('bridgeUrl').value.trim();
  const user = window.BRIDGE_USER || $('bridgeUser').value.trim();
  const pass = window.BRIDGE_PASS || $('bridgePass').value.trim();

  if(!url){
    simulateLocalTrade(body);
    return {ok:true, simulated:true};
  }
  try{
    const res = await fetch(url + '/api/trade', {
      method:'POST', headers:{'Content-Type':'application/json', 'Authorization': 'Basic '+btoa(user+':'+pass)}, body: JSON.stringify(body)
    });
    const j = await res.json();
    if(j && j.ok){
      simulateLocalTrade(body); // reflect locally too
      return j;
    } else {
      alert('Bridge rejected: ' + JSON.stringify(j));
      return j;
    }
  }catch(e){
    console.warn('bridge fail', e);
    alert('Bridge unreachable â€” trade simulated locally (demo).');
    simulateLocalTrade(body);
    return {ok:false,error:e.toString()};
  }
}

/* local simulation: open and then close */
function simulateLocalTrade(body){
  const now = Date.now();
  const trade = { id:'T'+now, pair:body.pair, cmd: body.cmd || body.type, price: body.price || (1 + Math.random()*0.02).toFixed(5), sl: body.sl, tp: body.tp, time: now, confidence: body.confidence || 90, vol: parseFloat($('lotVal').value)||0.01 };
  history.unshift({...trade, status:'open', note:'opened', time});
  renderHistory();
  // close after random time; pnl based on confidence
  setTimeout(()=>{
    const conf = trade.confidence; let winProb = Math.max(0.05, Math.min(0.95, (conf - 55) / 55 ));
    const win = Math.random() < winProb;
    const base = trade.vol * (win ? 40 : -40) * (0.5 + Math.random()*(conf/100));
    const pnl = parseFloat(base.toFixed(2));
    history.unshift({...trade, status: win ? 'win' : 'loss', pnl, closedAt: Date.now()});
    // update demo balance if demo
    if(load('lumina_account_mode','DEMO') === 'DEMO'){
      const cur = parseFloat($('balanceVal').textContent.replace(/[^0-9.-]+/g,""));
      const newBal = cur + pnl;
      $('balanceVal').textContent = '$' + newBal.toFixed(2);
      save('lumina_balance', newBal);
    }
    renderHistory();
  }, 6000 + Math.random()*8000);
}

/* ---------- marker on chart (small non-intrusive) ---------- */
function addMarkerOnChart(s){
  if(!showMarkers) return;
  try{
    const c = $('tv_chart_container');
    const badge = document.createElement('div');
    badge.style.position='absolute'; badge.style.right='10px'; badge.style.top=(40 + Math.random()*240)+'px';
    badge.style.padding='4px 8px'; badge.style.borderRadius='8px'; badge.style.zIndex=1200;
    badge.style.background = s.type==='buy' ? 'rgba(57,211,83,0.12)' : 'rgba(255,77,79,0.08)';
    badge.style.color = s.type==='buy' ? '#39d353' : '#ff4d4f';
    badge.textContent = `${s.type.toUpperCase()} ${s.confidence}%`;
    badge.id = 'b_'+s.id;
    c.appendChild(badge);
    setTimeout(()=>badge.remove(), 22000);
  }catch(e){}
}

/* ---------- background auto-analysis (removed Analyze button) ---------- */
async function runAnalysisForPair(pair, tf){
  // simulated deep analysis (replace with server call in production)
  await new Promise(r=>setTimeout(r, 900 + Math.random()*900));
  // generate simulated metrics
  const smaShort = 1 + ((Math.random()-0.5) * 0.01);
  const smaLong = smaShort + ((Math.random()-0.5) * 0.008);
  const atr = 0.0006 + Math.random()*0.0035;
  const volSpike = Math.random() > 0.78;
  let score = 50;
  score += smaShort > smaLong ? 28 : -6;
  score += Math.round((1/atr) * 2);
  if(volSpike) score += 10;
  score = Math.max(50, Math.min(110, Math.round(score)));
  const dir = (smaShort > smaLong) ? 'buy' : 'sell';
  const price = (1 + Math.random()*0.02).toFixed(5);
  const sl = (parseFloat(price) + (dir==='buy' ? -atr : atr)).toFixed(5);
  const tp = (parseFloat(price) + (dir==='buy' ? (atr*3) : (-atr*3))).toFixed(5);
  const analysis = { pair, tf, confidence: score, dir, price, sl, tp, time: Date.now(), notes: volSpike ? 'vol spike' : '' };
  lastAnalysis[pair] = analysis;
  // if very high confidence create signal automatically
  // In AUTO mode only add signal; actual auto-exec still requires allow Auto checked and conf >= autoMin
  if(score >= parseInt($('manualMin').value || 95)){
    addSignal({ pair, tf, price, sl, tp, type: dir, confidence: score });
  }
  return analysis;
}

// continuous auto-analysis across selected pair (and maybe many pairs later)
setInterval(async ()=>{
  try{
    const pair = $('pairSelect').value;
    const tf = $('timeframe').value;
    // run for current pair always; for full multi-pair scanning you'd iterate more pairs
    await runAnalysisForPair(pair, tf);
  }catch(e){}
}, AUTO_ANALYSIS_INTERVAL_MS);

/* ---------- UI wiring ---------- */
$('toggleMarkers').addEventListener('click', ()=>{ showMarkers = !showMarkers; alert('Markers: '+showMarkers); });
$('clearSignals').addEventListener('click', ()=>{ signals = []; renderSignals(); });
$('exportSignals').addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify(signals,null,2)],{type:'application/json'}); const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download='signals.json'; a.click(); URL.revokeObjectURL(u); });

/* buy/sell manual create */
$('buyBtn').addEventListener('click', ()=>{
  const p = $('pairSelect').value; const price = (1 + Math.random()*0.02).toFixed(5);
  const s = $('sl').value || (parseFloat(price)-0.002).toFixed(5); const t = $('tp').value || (parseFloat(price)+0.004).toFixed(5);
  addSignal({ pair:p, tf:$('timeframe').value, type:'buy', price, sl:s, tp:t, confidence: parseInt($('manualMin').value)||95 });
});
$('sellBtn').addEventListener('click', ()=>{
  const p = $('pairSelect').value; const price = (1 + Math.random()*0.02).toFixed(5);
  const s = $('sl').value || (parseFloat(price)+0.002).toFixed(5); const t = $('tp').value || (parseFloat(price)-0.004).toFixed(5);
  addSignal({ pair:p, tf:$('timeframe').value, type:'sell', price, sl:s, tp:t, confidence: parseInt($('manualMin').value)||95 });
});

/* exit all button */
$('exitAll').addEventListener('click', ()=>{ if(confirm('Exit all demo trades?')) { history = history.map(h=>({ ...h, status: h.status==='open' ? 'closed' : h.status })); renderHistory(); alert('All demo trades closed.'); } });

/* connect bridge store front-end */
$('connectBridge').addEventListener('click', ()=>{ window.BRIDGE_URL = $('bridgeUrl').value.trim(); window.BRIDGE_USER = $('bridgeUser').value.trim(); window.BRIDGE_PASS = $('bridgePass').value.trim(); alert('Bridge stored in this browser (demo). For production store server-side.'); });

/* lumina assistant open */
$('luminaBtn').addEventListener('click', ()=> $('luminaPanel').classList.toggle('open'));
$('luminaClose').addEventListener('click', ()=> $('luminaPanel').classList.remove('open'));

/* lumina chat send & mic */
$('luminaSend').addEventListener('click', ()=>{ const q = $('luminaInput').value.trim(); if(!q) return; appendChat('You', q); $('luminaInput').value=''; setTimeout(()=> luminaReply(q), 600); });
$('luminaMic').addEventListener('click', ()=>{
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition) return alert('Speech not supported');
  const r = new SpeechRecognition(); r.lang = $('langSelect').value || 'en-US';
  r.onresult = e => { $('luminaInput').value = e.results[0][0].transcript; $('luminaSend').click(); }; r.onerror = ()=>alert('Speech error'); r.start();
});
$('luminaClear').addEventListener('click', ()=>{ if(confirm('Delete assistant chat?')) $('luminaChat').innerHTML=''; });

function appendChat(who, text){
  const d = document.createElement('div'); d.className = who==='You' ? 'bubble you' : 'bubble lumina'; d.textContent = text; $('luminaChat').appendChild(d); $('luminaChat').scrollTop = $('luminaChat').scrollHeight;
}
function luminaReply(q){
  const voiceMode = $('voiceMode').value;
  if(/hi|hello|love|baby/i.test(q) && voiceMode==='girlfriend'){
    appendChat('Lumina', 'Hi baby ðŸ’• â€” I checked the chart. Want me to run a deeper scan? (I auto-scan so I already may have signals.)');
    if($('speakOn').checked) speak('Hi baby, I checked the chart for you.', $('langSelect').value);
    return;
  }
  if(/analyz|scan|order block|smart money/i.test(q)){
    appendChat('Lumina', 'I am running a deep analysis â€” results appear on the live signals panel. (Auto analysis runs automatically.)');
    if($('speakOn').checked) speak('I am running a deep analysis now.', $('langSelect').value);
    return;
  }
  appendChat('Lumina', `Lumina (${voiceMode}): I heard "${q}". For trades I analyze automatically and post signals in the Live Signals panel.`);
  if($('speakOn').checked) speak(q, $('langSelect').value);
}
function speak(txt, lang){ try{ const u=new SpeechSynthesisUtterance(txt); u.lang=lang||'en-US'; u.rate=1; u.pitch = $('voiceMode').value==='girlfriend'?1.05:1.0; speechSynthesis.speak(u); }catch(e){} }

/* lumina file & camera simple handlers */
$('luminaFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; appendChat('Lumina', 'File uploaded: '+f.name); });
$('luminaCamera').addEventListener('click', async ()=>{ try{ const s = await navigator.mediaDevices.getUserMedia({video:true}); const v = document.createElement('video'); v.autoplay=true; v.muted=true; v.playsInline=true; v.style.maxWidth='100%'; v.srcObject = s; $('luminaChat').appendChild(v); }catch(e){alert('Camera error');} });

/* toggle markers */
$('toggleMarkers').addEventListener('click', ()=>{ showMarkers = !showMarkers; alert('On-chart markers: '+showMarkers); });

/* keep selections persistent */
$('pairSelect').addEventListener('change', ()=> save('lumina_pair',$('pairSelect').value));
$('timeframe').addEventListener('change', ()=> save('lumina_timeframe',$('timeframe').value));
$('modeSelect').addEventListener('change', ()=> save('lumina_mode',$('modeSelect').value));
$('manualMin').addEventListener('change', ()=> save('lumina_manual_min',$('manualMin').value));
$('autoMin').addEventListener('change', ()=> save('lumina_auto_min',$('autoMin').value));

/* initial saved state */
(function initSaved(){
  const p = load('lumina_pair','EURUSD'); if(p) $('pairSelect').value = p;
  const tf = load('lumina_timeframe','60'); if(tf) $('timeframe').value = tf;
  const mm = load('lumina_manual_min',95); $('manualMin').value = mm;
  const am = load('lumina_auto_min',100); $('autoMin').value = am;
  const accMode = load('lumina_account_mode','DEMO'); $('modeBadge').textContent = accMode;
  // keep demo/real behavior after refresh: we only set badge; actual real trading requires bridge & EA
})();

/* small interval to keep widget responsive */
setInterval(()=>{ try{ if(tvWidget && tvWidget.activeChart) tvWidget.activeChart().resize(); }catch(e){} }, 2500);

/* finalize */
renderSignals(); renderHistory();

</script>
</body>
</html>
